<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pylhc.irnl_rdt_correction &mdash; pylhc 0.4.2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/omc_logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Entrypoints</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/analysis.html">Analysis Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#bsrt-analysis">BSRT Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#forced-da-analysis">Forced DA Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/bpm_calibration.html">BPM Calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/bpm_calibration.html#id1">BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/irnl_rdt_correction.html">IRNL RDT Correction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/irnl_rdt_correction.html#nonlinear-correction-calculation-in-the-irs">Nonlinear Correction calculation in the IRs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/machine_info.html">Machine Information Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/machine_info.html#print-machine-settings-overview">Print Machine Settings Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/machine_info.html#bsrt-logger">BSRT logger</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/calibration.html">BPM Calibration Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#beta">Beta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#dispersion">Dispersion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/constants.html">Constants Definitions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-general">Constants: General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-forced-da-analysis">Constants: Forced DA Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-machine-settings-info">Constants: Machine Settings Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-bpm-calibration">Constants: BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/data_extract.html">Data Extraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#pylsa">PyLSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#timber">Timber</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/utils.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/utils.html#additional-io-tools">Additional IO-Tools</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pylhc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>pylhc.irnl_rdt_correction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pylhc.irnl_rdt_correction</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Nonlinear Correction calculation in the IRs</span>
<span class="sd">--------------------------------------------</span>

<span class="sd">Performs local correction of the Resonance Driving Terms (RDTs)</span>
<span class="sd">in the Insertion Regions (IRs) based on the principle described in</span>
<span class="sd">[#BruningDynamicApertureStudies2004]_ with the addition of correcting</span>
<span class="sd">feed-down and using feed-down to correct lower order RDTs.</span>
<span class="sd">Details can be found in [#DillyNonlinearIRCorrections2022]_ .</span>

<span class="sd">This script is written to be used stand-alone if needed</span>
<span class="sd">with python 3.6+ and with ``tfs-pandas`` installed.</span>


<span class="sd">.. rubric:: References</span>

<span class="sd">..  [#BruningDynamicApertureStudies2004]</span>
<span class="sd">    O. Bruening et al.,</span>
<span class="sd">    Dynamic aperture studies for the LHC separation dipoles. (2004)</span>
<span class="sd">    https://cds.cern.ch/record/742967</span>

<span class="sd">..  [#DillyNonlinearIRCorrections2022]</span>
<span class="sd">    J. Dilly et al.,</span>
<span class="sd">    Corrections of high-order nonlinear errors in the LHC and HL-LHC insertion regions. (2022)</span>


<span class="sd">author: Joschua Dilly</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Callable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tfs</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Classes ----------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">IRCorrector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_component</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">accel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">order</span><span class="p">,</span> <span class="n">skew</span> <span class="o">=</span> <span class="n">field_component2order</span><span class="p">(</span><span class="n">field_component</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">field_component</span> <span class="o">=</span> <span class="n">field_component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">=</span> <span class="n">skew</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">accel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="n">side</span>

        <span class="n">main_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">ORDER_NAME_MAP</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="si">}{</span><span class="n">SKEW_NAME_MAP</span><span class="p">[</span><span class="n">skew</span><span class="p">]</span><span class="si">}</span><span class="s1">X&#39;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="k">if</span> <span class="n">accel</span> <span class="o">==</span> <span class="s2">&quot;hllhc&quot;</span> <span class="ow">and</span> <span class="n">ip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;M</span><span class="si">{</span><span class="n">main_name</span><span class="si">}{</span><span class="n">extra</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">POSITION</span><span class="si">:</span><span class="s1">d</span><span class="si">}{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;K</span><span class="si">{</span><span class="n">main_name</span><span class="si">}{</span><span class="n">POSITION</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strength_component</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">order</span><span class="o">-</span><span class="mi">1</span><span class="si">}{</span><span class="n">SKEW_NAME_MAP</span><span class="p">[</span><span class="n">skew</span><span class="p">]</span><span class="si">}</span><span class="s2">L&quot;</span>  <span class="c1"># MAD-X order notation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;IRCorrector object </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_component</span><span class="si">}</span><span class="s2">), </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strength_component</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2"> 6E</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">SIDES</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">SIDES</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">ip</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">SIDES</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">SIDES</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">ip</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">RDT</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jklm</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jklm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jklm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_beta_exp</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="c1"># swap beta-exponents</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;RDT object </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">order2field_component</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">skew</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">order</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>


<span class="c1"># Additional Classes ---</span>

<div class="viewcode-block" id="DotDict"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.DotDict">[docs]</a><span class="k">class</span> <span class="nc">DotDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make dict fields accessible by attributes.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DotDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Needed to raise the correct exceptions &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DotDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="Timer"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.Timer">[docs]</a><span class="k">class</span> <span class="nc">Timer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Collect Times and print a summary at the end. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">print_fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="nb">print</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">print_fun</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>
        <span class="n">time_</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_</span>
        <span class="k">return</span> <span class="n">time_</span>

    <span class="k">def</span> <span class="nf">time_since_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dtime</span>

    <span class="k">def</span> <span class="nf">time_between_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">list_steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">list_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">list_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">end</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dtime</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">str_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">time_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_between_steps</span><span class="p">())</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">format_str</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">step:</span><span class="si">{</span><span class="n">str_length</span><span class="si">}</span><span class="s2">s</span><span class="se">}}</span><span class="s2">:&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot; +</span><span class="se">{{</span><span class="s2">dtime: </span><span class="si">{</span><span class="n">time_length</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.5f</span><span class="se">}}</span><span class="s2">s&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot; (</span><span class="se">{{</span><span class="s2">ttime: </span><span class="si">{</span><span class="n">time_length</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.3f</span><span class="se">}}</span><span class="s2">s total)&quot;</span><span class="p">)</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">step_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">last_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">step_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timing Summary ----&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ttime</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">step_time</span><span class="o">-</span><span class="n">last_time</span><span class="p">,</span> <span class="n">ttime</span><span class="o">=</span><span class="n">step_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">last_time</span> <span class="o">=</span> <span class="n">step_time</span></div>


<span class="c1"># Constants --------------------------------------------------------------------</span>

<span class="n">POSITION</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># all NL correctors are at POSITION 3, to be adapted for Linear</span>
<span class="n">ORDER_NAME_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">}</span>
<span class="n">SKEW_NAME_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
<span class="n">SKEW_FIELD_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">}</span>
<span class="n">FIELD_SKEW_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">SKEW_FIELD_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">SKEW_CHAR_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;K&quot;</span><span class="p">}</span>

<span class="n">PLANES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
<span class="n">BETA</span> <span class="o">=</span> <span class="s2">&quot;BET&quot;</span>
<span class="n">DELTA</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
<span class="n">KEYWORD</span> <span class="o">=</span> <span class="s2">&quot;KEYWORD&quot;</span>
<span class="n">MULTIPOLE</span> <span class="o">=</span> <span class="s2">&quot;MULTIPOLE&quot;</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">PLANES</span>
<span class="n">SIDES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">)</span>


<span class="c1"># Default input options</span>
<span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;feeddown&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;ips&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
            <span class="s1">&#39;accel&#39;</span><span class="p">:</span> <span class="s1">&#39;lhc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solver&#39;</span><span class="p">:</span> <span class="s1">&#39;lstsq&#39;</span><span class="p">,</span>
            <span class="s1">&#39;update_optics&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;ignore_corrector_settings&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;rdts2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ignore_missing_columns&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

<span class="n">DEFAULT_RDTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lhc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;F0003&#39;</span><span class="p">,</span> <span class="s1">&#39;F0003*&#39;</span><span class="p">,</span>  <span class="c1"># correct a3 errors with F0003</span>
            <span class="s1">&#39;F1002&#39;</span><span class="p">,</span> <span class="s1">&#39;F1002*&#39;</span><span class="p">,</span>  <span class="c1"># correct b3 errors with F1002</span>
            <span class="s1">&#39;F1003&#39;</span><span class="p">,</span> <span class="s1">&#39;F3001&#39;</span><span class="p">,</span>  <span class="c1"># correct a4 errors with F1003 and F3001</span>
            <span class="s1">&#39;F4000&#39;</span><span class="p">,</span> <span class="s1">&#39;F0004&#39;</span><span class="p">,</span>  <span class="c1"># correct b4 errors with F4000 and F0004</span>
            <span class="s1">&#39;F6000&#39;</span><span class="p">,</span> <span class="s1">&#39;F0006&#39;</span><span class="p">,</span>  <span class="c1"># correct b6 errors with F6000 and F0006</span>
            <span class="p">),</span>
    <span class="s1">&#39;hllhc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;F0003&#39;</span><span class="p">,</span> <span class="s1">&#39;F0003*&#39;</span><span class="p">,</span>  <span class="c1"># correct a3 errors with F0003</span>
              <span class="s1">&#39;F1002&#39;</span><span class="p">,</span> <span class="s1">&#39;F1002*&#39;</span><span class="p">,</span>  <span class="c1"># correct b3 errors with F1002</span>
              <span class="s1">&#39;F1003&#39;</span><span class="p">,</span> <span class="s1">&#39;F3001&#39;</span><span class="p">,</span>  <span class="c1"># correct a4 errors with F1003 and F3001</span>
              <span class="s1">&#39;F0004&#39;</span><span class="p">,</span> <span class="s1">&#39;F4000&#39;</span><span class="p">,</span>  <span class="c1"># correct b4 errors with F0004 and F4000</span>
              <span class="s1">&#39;F0005&#39;</span><span class="p">,</span> <span class="s1">&#39;F0005*&#39;</span><span class="p">,</span>  <span class="c1"># correct a5 errors with F0005</span>
              <span class="s1">&#39;F5000&#39;</span><span class="p">,</span> <span class="s1">&#39;F5000*&#39;</span><span class="p">,</span>  <span class="c1"># correct b5 errors with F5000</span>
              <span class="s1">&#39;F5001&#39;</span><span class="p">,</span> <span class="s1">&#39;F1005&#39;</span><span class="p">,</span>  <span class="c1"># correct a6 errors with F5001 and F1005</span>
              <span class="s1">&#39;F6000&#39;</span><span class="p">,</span> <span class="s1">&#39;F0006&#39;</span><span class="p">,</span>  <span class="c1"># correct b6 errors with F6000 and F0006</span>
              <span class="p">),</span>
<span class="p">}</span>

<span class="n">EXT_TFS</span> <span class="o">=</span> <span class="s2">&quot;.tfs&quot;</span>  <span class="c1"># suffix for dataframe file</span>
<span class="n">EXT_MADX</span> <span class="o">=</span> <span class="s2">&quot;.madx&quot;</span>  <span class="c1"># suffix for madx-command file</span>


<span class="c1"># Solving functions ---</span>

<span class="k">def</span> <span class="nf">_solve_linear</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="n">_assign_corrector_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_solve_invert</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
    <span class="n">_assign_corrector_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_solve_lstsq</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_assign_corrector_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residuals ||I - Bx||_2: </span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rank of Beta-Matrix: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">SOLVER_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inv&#39;</span><span class="p">:</span> <span class="n">_solve_invert</span><span class="p">,</span>
              <span class="s1">&#39;lstsq&#39;</span><span class="p">:</span> <span class="n">_solve_lstsq</span><span class="p">,</span>
              <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="n">_solve_linear</span><span class="p">,}</span>


<span class="n">APPROXIMATE_SOLVERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lstsq&#39;</span><span class="p">]</span>


<span class="c1"># Main Functions ---</span>

<span class="k">def</span> <span class="nf">get_parser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--optics&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;optics&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path(s) to optics file(s). Defines which elements to correct for!&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--errors&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path(s) to error file(s).&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--beams&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;beams&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which beam the files come from (1, 2 or 4)&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Path to write command and tfs_df file. &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Extension (if given) is ignored and replaced with </span><span class="si">{</span><span class="n">EXT_TFS</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">EXT_MADX</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="s2">&quot;for the Dataframe and the command file respectively.&quot;</span>
              <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rdts&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;rdts&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;RDTs to correct.&quot;</span>
              <span class="s2">&quot; Format: &#39;Fjklm&#39;; or &#39;Fjklm*&#39;&quot;</span>
              <span class="s2">&quot; to correct for this RDT in Beam 2 using&quot;</span>
              <span class="s2">&quot; beta-symmetry (jk &lt;-&gt; lm).&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rdts2&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;rdts2&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;RDTs to correct for second beam/file, if different from first.&quot;</span>
              <span class="s2">&quot; Same format rules as for `rdts`.&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--accel&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;accel&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_RDTS</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s1">&#39;accel&#39;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which accelerator we have.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--feeddown&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;feeddown&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Order of Feeddown to include.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s1">&#39;feeddown&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ips&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ips&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In which IPs to correct.&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s1">&#39;ips&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--solver&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;solver&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Solving method to use.&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">SOLVER_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--update_optics&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;update_optics&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Sorts the RDTs to start with the highest order and updates the &quot;</span>
              <span class="s2">&quot;corrector strengths in the optics after calculation, so the &quot;</span>
              <span class="s2">&quot;feeddown to lower order correctors is included.&quot;</span>
              <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;update_optics&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--iterations&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;iterations&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Reiterate correction, &quot;</span>
              <span class="s2">&quot;starting with the previously calculated values.&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ignore_corrector_settings&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ignore_corrector_settings&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Ignore the current settings of the correctors. If this is not set &quot;</span>
              <span class="s2">&quot;the corrector values of the optics are used as initial conditions.&quot;</span><span class="p">),</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ignore_missing_columns&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ignore_missing_columns&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;If set, missing strength columns in any of the input files &quot;</span>
              <span class="s2">&quot;are assumed to be zero, instead of raising an error.&quot;</span><span class="p">),</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">**</span><span class="n">opt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Get correctors and their optimal powering to minimize the given RDTs.</span>

<span class="sd">    Keyword Args:</span>

<span class="sd">        optics (list[str/Path/DataFrame]): Path(s) to optics file(s) or DataFrame(s) of optics.</span>
<span class="sd">                                           Needs to contain only the elements to be corrected</span>
<span class="sd">                                           (e.g. only the ones in the IRs).</span>
<span class="sd">                                           All elements from the error-files need to be present.</span>
<span class="sd">                                           Required!</span>
<span class="sd">        errors (list[str/Path/DataFrame]): Path(s) to error file(s) or DataFrame(s) of errors.</span>
<span class="sd">                                           Can contain less elements than the optics files,</span>
<span class="sd">                                           these elements are then assumed to have no errors.</span>
<span class="sd">                                           Required!</span>
<span class="sd">        beams (list[int]): Which beam the files come from (1, 2 or 4).</span>
<span class="sd">                           Required!</span>
<span class="sd">        output (str/Path): Path to write command and tfs_df file.</span>
<span class="sd">                           Extension (if given) is ignored and replaced with &#39;.tfs&#39; and &#39;.madx&#39;</span>
<span class="sd">                           for the Dataframe and the command file respectively.</span>
<span class="sd">                           Default: ``None``.</span>
<span class="sd">        rdts (list[str], dict[str, list[str]):</span>
<span class="sd">                          RDTs to correct.</span>
<span class="sd">                          Format: &#39;Fjklm&#39;; or &#39;Fjklm*&#39; to correct for</span>
<span class="sd">                          this RDT in Beam 2 using beta-symmetry (jk &lt;-&gt; lm).</span>
<span class="sd">                          The RDTs can be either given as a list, then the appropriate correctors</span>
<span class="sd">                          are determined by jklmn.</span>
<span class="sd">                          Alternatively, the input can be a dictionary,</span>
<span class="sd">                          where the keys are the RDT names as before, and the values are a list</span>
<span class="sd">                          of correctors to use, e.g. &#39;b5&#39; for normal decapole corrector,</span>
<span class="sd">                          &#39;a3&#39; for skew sextupole, etc.</span>
<span class="sd">                          If the order of the corrector is higher than the order of the RDT,</span>
<span class="sd">                          the feed-down from the corrector is used for correction.</span>
<span class="sd">                          In the case where multiple orders of correctors are used,</span>
<span class="sd">                          increasing ``iterations`` might be useful.</span>
<span class="sd">                          Default: Standard RDTs for given ``accel`` (see ``DEFAULT_RDTS`` in this file).</span>
<span class="sd">        rdts2 (list[str], dict[str, list[str]):</span>
<span class="sd">                           RDTs to correct for second beam/file, if different from first.</span>
<span class="sd">                           Same format rules as for ``rdts``. Default: ``None``.</span>
<span class="sd">        accel (str): Which accelerator we have. One of &#39;lhc&#39;, &#39;hllhc&#39;.</span>
<span class="sd">                     Default: ``lhc``.</span>
<span class="sd">        feeddown (int): Order of Feeddown to include.</span>
<span class="sd">                        Default: ``0``.</span>
<span class="sd">        ips (list[int]): In which IPs to correct.</span>
<span class="sd">                         Default: ``[1, 2, 5, 8]``.</span>
<span class="sd">        solver (str): Solver to use. One of &#39;lstsq&#39;, &#39;inv&#39; or &#39;linear&#39;.</span>
<span class="sd">                      Default ``lstsq``.</span>
<span class="sd">        update_optics (bool): Sorts the RDTs to start with the highest order</span>
<span class="sd">                              and updates the corrector strengths in the optics</span>
<span class="sd">                              after calculation, so the feeddown to lower order</span>
<span class="sd">                              correctors is included.</span>
<span class="sd">                              Default: ``True``.</span>
<span class="sd">        ignore_corrector_settings (bool): Ignore the current settings of the correctors.</span>
<span class="sd">                                          If this is not set the corrector values of the</span>
<span class="sd">                                          optics are used as initial conditions.</span>
<span class="sd">                                          Default: ``False``.</span>
<span class="sd">        ignore_missing_columns (bool): If set, missing strength columns in any</span>
<span class="sd">                                       of the input files are assumed to be</span>
<span class="sd">                                       zero, instead of raising an error.</span>
<span class="sd">                                       Default: ``False``.</span>
<span class="sd">        iterations (int): Reiterate correction, starting with the previously</span>
<span class="sd">                          calculated values.</span>
<span class="sd">                          Default: ``1``.</span>


<span class="sd">    Returns:</span>

<span class="sd">        tuple[string, Dataframe]:</span>
<span class="sd">        the string contains the madx-commands used to power the correctors;</span>
<span class="sd">        the dataframe contains the same values in a pandas DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting IRNL Correction.&quot;</span><span class="p">)</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="n">print_fun</span><span class="o">=</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">get_parser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">DotDict</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">_check_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Opt Parsed&quot;</span><span class="p">)</span>

    <span class="n">rdt_maps</span> <span class="o">=</span> <span class="n">sort_rdts</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">rdts</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">rdts2</span><span class="p">)</span>
    <span class="n">_check_corrector_order</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">update_optics</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span><span class="p">)</span>
    <span class="n">needed_orders</span> <span class="o">=</span> <span class="n">_get_needed_orders</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;RDT Sorted&quot;</span><span class="p">)</span>

    <span class="n">optics_dfs</span> <span class="o">=</span> <span class="n">get_tfs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">optics</span><span class="p">)</span>
    <span class="n">errors_dfs</span> <span class="o">=</span> <span class="n">get_tfs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Optics Loaded&quot;</span><span class="p">)</span>

    <span class="n">_check_dfs</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="n">needed_orders</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">ignore_missing_columns</span><span class="p">)</span>
    <span class="n">switch_signs_for_beam4</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Optics Checked&quot;</span><span class="p">)</span>

    <span class="n">correctors</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

    <span class="n">timer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s1">&#39;No correctors found in input optics.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_and_write_output</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">correctors</span><span class="p">)</span></div>


<div class="viewcode-block" id="solve"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.solve">[docs]</a><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate corrections.</span>
<span class="sd">    They are grouped into rdt&#39;s with common correctors. If possible, these are</span>
<span class="sd">    ordered from highest order to lowest, to be able to update optics and include</span>
<span class="sd">    their feed-down. &quot;&quot;&quot;</span>
    <span class="n">all_correctors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining_rdt_maps</span> <span class="o">=</span> <span class="n">rdt_maps</span>
    <span class="k">while</span> <span class="n">remaining_rdt_maps</span><span class="p">:</span>
        <span class="n">current_rdt_maps</span><span class="p">,</span> <span class="n">remaining_rdt_maps</span><span class="p">,</span> <span class="n">corrector_names</span> <span class="o">=</span> <span class="n">_get_current_rdt_maps</span><span class="p">(</span><span class="n">remaining_rdt_maps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">ips</span><span class="p">:</span>
            <span class="n">correctors</span> <span class="o">=</span> <span class="n">get_available_correctors</span><span class="p">(</span><span class="n">corrector_names</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">accel</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">)</span>
            <span class="n">all_correctors</span> <span class="o">+=</span> <span class="n">correctors</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># warnings are logged in get_available_correctors</span>

            <span class="n">saved_corrector_values</span> <span class="o">=</span> <span class="n">init_corrector_and_optics_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span>
                                                                      <span class="n">opt</span><span class="o">.</span><span class="n">update_optics</span><span class="p">,</span>
                                                                      <span class="n">opt</span><span class="o">.</span><span class="n">ignore_corrector_settings</span><span class="p">)</span>

            <span class="n">beta_matrix</span><span class="p">,</span> <span class="n">integral</span> <span class="o">=</span> <span class="n">build_equation_system</span><span class="p">(</span>
                <span class="n">current_rdt_maps</span><span class="p">,</span> <span class="n">correctors</span><span class="p">,</span>
                <span class="n">ip</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
                <span class="n">solve_equation_system</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">beta_matrix</span><span class="p">,</span> <span class="n">integral</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>  <span class="c1"># changes corrector values</span>
                <span class="n">update_optics</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">)</span>  <span class="c1"># update corrector values in optics</span>

                <span class="c1"># update integral values after iteration:</span>
                <span class="n">integral_before</span> <span class="o">=</span> <span class="n">integral</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">integral</span> <span class="o">=</span> <span class="n">build_equation_system</span><span class="p">(</span>
                    <span class="n">current_rdt_maps</span><span class="p">,</span> <span class="p">[],</span>  <span class="c1"># empty correctors list skips beta-matrix calculation</span>
                    <span class="n">ip</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span>
                <span class="p">)</span>
                <span class="n">_log_correction</span><span class="p">(</span><span class="n">integral_before</span><span class="p">,</span> <span class="n">integral</span><span class="p">,</span> <span class="n">current_rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correction of IP</span><span class="si">{</span><span class="n">ip</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> complete.&quot;</span><span class="p">)</span>
            <span class="n">restore_optics_values</span><span class="p">(</span><span class="n">saved_corrector_values</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">)</span>  <span class="c1"># hint: nothing saved if update_optics is True</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_correctors</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_current_rdt_maps</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a new rdt_map with all rdt&#39;s that share correctors.  &quot;&quot;&quot;</span>
    <span class="n">n_maps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">)</span>
    <span class="n">new_rdt_map</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">rdt_map</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">:</span>
        <span class="c1"># get next RDT/correctors</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdt_map</span><span class="p">):</span>
            <span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rdt_map</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rdt_maps are empty. &quot;</span>
                         <span class="s2">&quot;This should have triggered an end of the solver loop &quot;</span>
                         <span class="s2">&quot;earlier. Please investigate.&quot;</span><span class="p">)</span>

    <span class="n">correctors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span>
    <span class="n">checked_correctors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">):</span>
        <span class="c1"># find all RDTs with the same correctors</span>
        <span class="n">checked_correctors</span> <span class="o">|=</span> <span class="n">correctors</span>
        <span class="n">additional_correctors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># new correctors found this loop</span>

        <span class="k">for</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_maps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rdt_current</span><span class="p">,</span> <span class="n">rdt_correctors</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">rdt_correctors</span><span class="p">:</span>
                        <span class="n">new_rdt_map</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">rdt_current</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdt_correctors</span>
                        <span class="n">additional_correctors</span> <span class="o">|=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rdt_correctors</span><span class="p">)</span> <span class="o">-</span> <span class="n">checked_correctors</span><span class="p">)</span>

        <span class="n">correctors</span> <span class="o">=</span> <span class="n">additional_correctors</span>

    <span class="n">remaining_rdt_map</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_rdt_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_maps</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rrm</span><span class="p">)</span> <span class="k">for</span> <span class="n">rrm</span> <span class="ow">in</span> <span class="n">remaining_rdt_map</span><span class="p">):</span>
        <span class="n">remaining_rdt_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">new_rdt_map</span><span class="p">,</span> <span class="n">remaining_rdt_map</span><span class="p">,</span> <span class="n">checked_correctors</span>


<span class="c1"># RDT Sorting ------------------------------------------------------------------</span>

<div class="viewcode-block" id="sort_rdts"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.sort_rdts">[docs]</a><span class="k">def</span> <span class="nf">sort_rdts</span><span class="p">(</span><span class="n">rdts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">rdts2</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Sorts RDTs by reversed-order and orientation (skew, normal). &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sorting RDTs&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - First Optics:&quot;</span><span class="p">)</span>
    <span class="n">rdt_dict</span> <span class="o">=</span> <span class="n">_build_rdt_dict</span><span class="p">(</span><span class="n">rdts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdts2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Second Optics:&quot;</span><span class="p">)</span>
        <span class="n">rdt_dict2</span> <span class="o">=</span> <span class="n">_build_rdt_dict</span><span class="p">(</span><span class="n">rdts2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Second Optics: same RDTs as first.&quot;</span><span class="p">)</span>
        <span class="n">rdt_dict2</span> <span class="o">=</span> <span class="n">rdt_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rdt_dict</span><span class="p">,</span> <span class="n">rdt_dict2</span></div>


<span class="k">def</span> <span class="nf">_build_rdt_dict</span><span class="p">(</span><span class="n">rdts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building RDT dictionary.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">rdts</span> <span class="o">=</span> <span class="p">{</span><span class="n">rdt</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">rdt</span> <span class="ow">in</span> <span class="n">rdts</span><span class="p">}</span>

    <span class="n">rdt_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rdt_name</span><span class="p">,</span> <span class="n">correctors</span> <span class="ow">in</span> <span class="n">rdts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">rdt</span> <span class="o">=</span> <span class="n">RDT</span><span class="p">(</span><span class="n">rdt_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">):</span>
            <span class="n">skew</span> <span class="o">=</span> <span class="n">rdt</span><span class="o">.</span><span class="n">skew</span>
            <span class="n">correctors</span> <span class="o">=</span> <span class="p">[</span><span class="n">order2field_component</span><span class="p">(</span><span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">skew</span><span class="p">)]</span>

        <span class="n">rdt_dict</span><span class="p">[</span><span class="n">rdt</span><span class="p">]</span> <span class="o">=</span> <span class="n">correctors</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: </span><span class="si">{</span><span class="n">rdt</span><span class="si">}</span><span class="s2"> with correctors: </span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">rdt_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rdt_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># sorts by highest order and skew first</span>
    <span class="k">return</span> <span class="n">rdt_dict</span>


<span class="k">def</span> <span class="nf">_get_needed_orders</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">feed_down</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns the sorted orders needed for correction, based on the order</span>
<span class="sd">    of the RDTs to correct plus the feed-down involved and the order of the</span>
<span class="sd">    corrector, which can be higher than the RDTs in case one wants to correct</span>
<span class="sd">    via feeddown.&quot;&quot;&quot;</span>
    <span class="n">needed_orders</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rdt_map</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span> <span class="ow">in</span> <span class="n">rdt_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># get orders from RDTs + feed-down</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feed_down</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">needed_orders</span> <span class="o">|=</span> <span class="p">{</span><span class="n">rdt</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fd</span><span class="p">,</span> <span class="p">}</span>

            <span class="c1"># get orders from correctors</span>
            <span class="k">for</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">:</span>
                <span class="n">needed_orders</span> <span class="o">|=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">corrector</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">needed_orders</span><span class="p">)</span>


<span class="c1"># Equation System -------------------------------------------------------------</span>

<div class="viewcode-block" id="build_equation_system"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.build_equation_system">[docs]</a><span class="k">def</span> <span class="nf">build_equation_system</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">],</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span>
                          <span class="n">feeddown</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Builds equation system as in Eq. (43) in [#DillyNonlinearIRCorrections2022]_</span>
<span class="sd">    for a given ip for all given optics and error files (i.e. beams) and rdts.</span>

<span class="sd">    Returns</span>
<span class="sd">        b_matrix: np.array N_rdts x  N_correctors</span>
<span class="sd">        integral: np.array N_rdts x 1</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="n">n_rdts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rdt_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">rdt_map</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">))</span>
    <span class="n">b_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_rdts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">)])</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_rdts</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">idx_row</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># row in equation system</span>
    <span class="k">for</span> <span class="n">idx_file</span><span class="p">,</span> <span class="n">rdts</span><span class="p">,</span> <span class="n">optics_df</span><span class="p">,</span> <span class="n">errors_df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rdt</span><span class="p">,</span> <span class="n">rdt_correctors</span> <span class="ow">in</span> <span class="n">rdts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating </span><span class="si">{</span><span class="n">rdt</span><span class="si">}</span><span class="s2">, optics </span><span class="si">{</span><span class="n">idx_file</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span><span class="si">}</span><span class="s2">, IP</span><span class="si">{</span><span class="n">ip</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">integral</span><span class="p">[</span><span class="n">idx_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_elements_integral</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">optics_df</span><span class="p">,</span> <span class="n">errors_df</span><span class="p">,</span> <span class="n">feeddown</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx_corrector</span><span class="p">,</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">correctors</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">corrector</span><span class="o">.</span><span class="n">field_component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rdt_correctors</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">b_matrix</span><span class="p">[</span><span class="n">idx_row</span><span class="p">][</span><span class="n">idx_corrector</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_corrector_coefficient</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">optics_df</span><span class="p">,</span> <span class="n">errors_df</span><span class="p">)</span>
            <span class="n">idx_row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">integral</span></div>


<span class="k">def</span> <span class="nf">_log_correction</span><span class="p">(</span><span class="n">integral_before</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">integral_after</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">rdt_maps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
                    <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Log the correction initial and final value of this iteration. &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RDT change in IP</span><span class="si">{</span><span class="n">ip</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="n">integral_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">integral_before</span><span class="p">,</span> <span class="n">integral_after</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx_optics</span><span class="p">,</span> <span class="n">rdts</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rdt_maps</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rdt</span> <span class="ow">in</span> <span class="n">rdts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">val_before</span><span class="p">,</span> <span class="n">val_after</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">integral_iter</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">val_after</span> <span class="o">-</span> <span class="n">val_before</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optics </span><span class="si">{</span><span class="n">idx_optics</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rdt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val_before</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">val_after</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">+.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_available_correctors"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.get_available_correctors">[docs]</a><span class="k">def</span> <span class="nf">get_available_correctors</span><span class="p">(</span><span class="n">field_components</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">accel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Gets the available correctors by checking for their presence in the optics.</span>
<span class="sd">    If the corrector is not found in this ip, the ip is skipped.</span>
<span class="sd">    If only one corrector (left or right) is present a warning is issued.</span>
<span class="sd">    If one corrector is present in only one optics (and not in the other)</span>
<span class="sd">    an Environment Error is raised. &quot;&quot;&quot;</span>
    <span class="n">correctors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_component</span> <span class="ow">in</span> <span class="n">field_components</span><span class="p">:</span>
        <span class="n">corrector_not_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corrector_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">SIDES</span><span class="p">:</span>
            <span class="n">corrector</span> <span class="o">=</span> <span class="n">IRCorrector</span><span class="p">(</span><span class="n">field_component</span><span class="p">,</span> <span class="n">accel</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">side</span><span class="p">)</span>
            <span class="n">corr_in_optics</span> <span class="o">=</span> <span class="p">[</span><span class="n">_corrector_in_optics</span><span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">optics_dfs</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">corr_in_optics</span><span class="p">):</span>
                <span class="n">correctors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corrector</span><span class="p">)</span>
                <span class="n">corrector_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">corr_in_optics</span><span class="p">):</span>
                <span class="c1"># Raise informative Error</span>
                <span class="n">idx_true</span> <span class="o">=</span> <span class="n">corr_in_optics</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">idx_false</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_true</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Corrector </span><span class="si">{</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> was found&#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;in the </span><span class="si">{</span><span class="n">idx2str</span><span class="p">(</span><span class="n">idx_true</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> optics&#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;but not in the </span><span class="si">{</span><span class="n">idx2str</span><span class="p">(</span><span class="n">idx_false</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;optics.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ignore Corrector</span>
                <span class="n">corrector_not_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrector_not_found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Corrector </span><span class="si">{</span><span class="n">corrector_not_found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> could not be found in &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;optics, yet </span><span class="si">{</span><span class="n">corrector_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> was present. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Correction will be performed with available corrector(s) only.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrector_not_found</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Correctors </span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">corrector_not_found</span><span class="p">)</span><span class="si">}</span><span class="s1"> were not found in&#39;</span>
                     <span class="sa">f</span><span class="s1">&#39; optics. Skipping IP</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">correctors</span><span class="p">))</span>  <span class="c1"># do not have to be sorted, but looks nicer</span></div>


<div class="viewcode-block" id="init_corrector_and_optics_values"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.init_corrector_and_optics_values">[docs]</a><span class="k">def</span> <span class="nf">init_corrector_and_optics_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">],</span> <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">update_optics</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">ignore_settings</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If wished save original corrector values from optics (for later restoration)</span>
<span class="sd">    and sync corrector values in list and optics. &quot;&quot;&quot;</span>
    <span class="n">saved_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">corrector</span><span class="o">.</span><span class="n">strength_component</span><span class="p">]</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">optics_dfs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_optics</span><span class="p">:</span>
            <span class="n">saved_values</span><span class="p">[</span><span class="n">corrector</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="k">if</span> <span class="n">ignore_settings</span><span class="p">:</span>
            <span class="c1"># set corrector value in optics to zero</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">optics_dfs</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">corrector</span><span class="o">.</span><span class="n">strength_component</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial value for corrector </span><span class="si">{</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> differs &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;between optics.&quot;</span><span class="p">)</span>
            <span class="c1"># use optics value as initial value</span>
            <span class="n">corrector</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">saved_values</span></div>


<div class="viewcode-block" id="restore_optics_values"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.restore_optics_values">[docs]</a><span class="k">def</span> <span class="nf">restore_optics_values</span><span class="p">(</span><span class="n">saved_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Restore saved initial corrector values (if any) to optics. &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">corrector</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">saved_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">corrector</span><span class="o">.</span><span class="n">strength_component</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>


<div class="viewcode-block" id="get_elements_integral"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.get_elements_integral">[docs]</a><span class="k">def</span> <span class="nf">get_elements_integral</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">optics_df</span><span class="p">,</span> <span class="n">errors_df</span><span class="p">,</span> <span class="n">feeddown</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the RDT integral for all elements of the IP. &quot;&quot;&quot;</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lm</span><span class="p">,</span> <span class="n">jk</span> <span class="o">=</span> <span class="n">rdt</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">rdt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">rdt</span><span class="o">.</span><span class="n">j</span> <span class="o">+</span> <span class="n">rdt</span><span class="o">.</span><span class="n">k</span>
    <span class="c1"># Integral on side ---</span>
    <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">SIDES</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Integral on side </span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">side_sign</span> <span class="o">=</span> <span class="n">get_integral_sign</span><span class="p">(</span><span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">side</span><span class="p">)</span>

        <span class="c1"># get IP elements, errors and twiss have same elements because of check_dfs</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">optics_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;.*</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">(\.B[12])?&quot;</span><span class="p">)]</span>

        <span class="n">betax</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BETA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">betay</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BETA</span><span class="si">}{</span><span class="n">Y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rdt</span><span class="o">.</span><span class="n">swap_beta_exp</span><span class="p">:</span>
            <span class="c1"># in case of beta-symmetry, this corrects for the same RDT in the opposite beam.</span>
            <span class="n">betax</span> <span class="o">=</span> <span class="n">betax</span><span class="o">**</span><span class="p">(</span><span class="n">lm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">betay</span> <span class="o">=</span> <span class="n">betay</span><span class="o">**</span><span class="p">(</span><span class="n">jk</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">betax</span> <span class="o">=</span> <span class="n">betax</span><span class="o">**</span><span class="p">(</span><span class="n">jk</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">betay</span> <span class="o">=</span> <span class="n">betay</span><span class="o">**</span><span class="p">(</span><span class="n">lm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="n">X</span><span class="p">]</span> <span class="o">+</span> <span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="n">Y</span><span class="p">]</span> <span class="o">+</span> <span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">Y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">dx_idy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span>

        <span class="n">k_sum</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>  <span class="c1"># Complex sum of strengths (from K_n + iJ_n) and feed-down to them</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feeddown</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">n_mad</span> <span class="o">=</span> <span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="o">+</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">kl_opt</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">n_mad</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">L&quot;</span><span class="p">]</span>
            <span class="n">kl_err</span> <span class="o">=</span> <span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">n_mad</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">L&quot;</span><span class="p">]</span>
            <span class="n">iksl_opt</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">n_mad</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">SL&quot;</span><span class="p">]</span>
            <span class="n">iksl_err</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elements</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">n_mad</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">SL&quot;</span><span class="p">]</span>

            <span class="n">k_sum</span> <span class="o">+=</span> <span class="p">((</span><span class="n">kl_opt</span> <span class="o">+</span> <span class="n">kl_err</span> <span class="o">+</span> <span class="n">iksl_opt</span> <span class="o">+</span> <span class="n">iksl_err</span><span class="p">)</span> <span class="o">*</span>
                      <span class="p">(</span><span class="n">dx_idy</span><span class="o">**</span><span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

        <span class="n">integral</span> <span class="o">+=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i_pow</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_sum</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="n">side_sign</span> <span class="o">*</span> <span class="n">betax</span> <span class="o">*</span> <span class="n">betay</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; -&gt; Sum value: </span><span class="si">{</span><span class="n">integral</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">integral</span></div>


<div class="viewcode-block" id="get_corrector_coefficient"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.get_corrector_coefficient">[docs]</a><span class="k">def</span> <span class="nf">get_corrector_coefficient</span><span class="p">(</span><span class="n">rdt</span><span class="p">:</span> <span class="n">RDT</span><span class="p">,</span> <span class="n">corrector</span><span class="p">:</span> <span class="n">IRCorrector</span><span class="p">,</span> <span class="n">optics_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">errors_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate B-Matrix Element for Corrector. &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Corrector </span><span class="si">{</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">lm</span><span class="p">,</span> <span class="n">jk</span> <span class="o">=</span> <span class="n">rdt</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">rdt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">rdt</span><span class="o">.</span><span class="n">j</span> <span class="o">+</span> <span class="n">rdt</span><span class="o">.</span><span class="n">k</span>

    <span class="n">sign_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i_pow</span><span class="p">(</span><span class="n">lm</span> <span class="o">+</span> <span class="p">(</span><span class="n">lm</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)))</span>  <span class="c1"># i_pow is always real</span>
    <span class="n">sign_corrector</span> <span class="o">=</span> <span class="n">sign_i</span> <span class="o">*</span> <span class="n">get_integral_sign</span><span class="p">(</span><span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">corrector</span><span class="o">.</span><span class="n">side</span><span class="p">)</span>

    <span class="n">betax</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BETA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">betay</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BETA</span><span class="si">}{</span><span class="n">Y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rdt</span><span class="o">.</span><span class="n">swap_beta_exp</span><span class="p">:</span>
        <span class="c1"># in case of beta-symmetry, this corrects for the same RDT in the opposite beam.</span>
        <span class="n">betax</span> <span class="o">=</span> <span class="n">betax</span><span class="o">**</span><span class="p">(</span><span class="n">lm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">betay</span> <span class="o">=</span> <span class="n">betay</span><span class="o">**</span><span class="p">(</span><span class="n">jk</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">betax</span> <span class="o">=</span> <span class="n">betax</span><span class="o">**</span><span class="p">(</span><span class="n">jk</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">betay</span> <span class="o">=</span> <span class="n">betay</span><span class="o">**</span><span class="p">(</span><span class="n">lm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">order</span> <span class="o">-</span> <span class="n">rdt</span><span class="o">.</span><span class="n">order</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
        <span class="c1"># Corrector contributes via feed-down</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">]</span> <span class="o">+</span> <span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">optics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Y</span><span class="p">]</span> <span class="o">+</span> <span class="n">errors_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">Y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">dx_idy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span>
        <span class="n">z_cmplx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx_idy</span><span class="o">**</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">corrector</span><span class="o">.</span><span class="n">skew</span> <span class="ow">and</span> <span class="n">is_odd</span><span class="p">(</span><span class="n">lm</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">corrector</span><span class="o">.</span><span class="n">skew</span> <span class="ow">and</span> <span class="n">is_even</span><span class="p">(</span><span class="n">lm</span><span class="p">)):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">z_cmplx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">z_cmplx</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">corrector</span><span class="o">.</span><span class="n">skew</span><span class="p">:</span>
               <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Z-coefficient for </span><span class="si">{</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">rdt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is very small.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sign_corrector</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">betax</span> <span class="o">*</span> <span class="n">betay</span></div>


<div class="viewcode-block" id="get_integral_sign"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.get_integral_sign">[docs]</a><span class="k">def</span> <span class="nf">get_integral_sign</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Sign of the integral and corrector for this side.</span>

<span class="sd">    This is the exp(iπnθ(s_w−s_IP)) part of Eq. (40) in</span>
<span class="sd">    [#DillyNonlinearIRCorrections2022]_,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
        <span class="c1"># return (-1)**n</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<span class="k">def</span> <span class="nf">_corrector_in_optics</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Checks if corrector is present in optics and has the KEYWORD MULTIPOLE. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not found in optics.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">KEYWORD</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">KEYWORD</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">MULTIPOLE</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> found in optics, yet the Keyword was </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">KEYWORD</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; (should be &#39;</span><span class="si">{</span><span class="n">MULTIPOLE</span><span class="si">}</span><span class="s2">&#39;).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">KEYWORD</span><span class="si">}</span><span class="s2">&#39; column not found in optics.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Assumes you have filtered </span><span class="si">{</span><span class="n">MULTIPOLE</span><span class="si">}</span><span class="s2">s beforehand!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># Solve ---</span>

<div class="viewcode-block" id="solve_equation_system"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.solve_equation_system">[docs]</a><span class="k">def</span> <span class="nf">solve_equation_system</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">],</span> <span class="n">lhs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Solves the system with the given solver.</span>

<span class="sd">    The result is transferred to the corrector values internally. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span> <span class="ow">and</span> <span class="n">solver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">APPROXIMATE_SOLVERS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Overdetermined equation systems can only be solved &quot;</span>
                         <span class="s2">&quot;by one of the approximate solvers&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">APPROXIMATE_SOLVERS</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Instead &#39;</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">&#39; was chosen.&quot;</span><span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solving Equation system via </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># lhs x corrector = rhs -&gt; correctors = lhs\rhs</span>
    <span class="n">SOLVER_MAP</span><span class="p">[</span><span class="n">solver</span><span class="p">](</span><span class="n">correctors</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_assign_corrector_values</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Assigns calculated values to the correctors. &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">corr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">correctors</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple Values for corrector </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="si">}</span><span class="s2"> found.&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; There should be only one.&quot;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating Corrector: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">+.2e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">corr</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span>


<span class="c1"># Update Optics ----------------------------------------------------------------</span>

<div class="viewcode-block" id="update_optics"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.update_optics">[docs]</a><span class="k">def</span> <span class="nf">update_optics</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">IRCorrector</span><span class="p">],</span> <span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Updates the corrector strength values in the current optics. &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">optics</span> <span class="ow">in</span> <span class="n">optics_dfs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">:</span>
            <span class="n">optics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corrector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">corrector</span><span class="o">.</span><span class="n">strength_component</span><span class="p">]</span> <span class="o">=</span> <span class="n">corrector</span><span class="o">.</span><span class="n">value</span></div>


<span class="c1"># Order Checks -----------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">_check_corrector_order</span><span class="p">(</span><span class="n">rdt_maps</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">update_optics</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">feed_down</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Perform checks on corrector orders compared to RDT orders and feed-down. &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">rdt_map</span> <span class="ow">in</span> <span class="n">rdt_maps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span> <span class="ow">in</span> <span class="n">rdt_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_check_corrector_order_not_lower</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span><span class="p">)</span>
            <span class="n">_check_update_optics</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span><span class="p">,</span> <span class="n">rdt_map</span><span class="p">,</span> <span class="n">update_optics</span><span class="p">,</span> <span class="n">feed_down</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_update_optics</span><span class="p">(</span><span class="n">rdt</span><span class="p">:</span> <span class="n">RDT</span><span class="p">,</span> <span class="n">correctors</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rdt_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">update_optics</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">feed_down</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if corrector values are set before they would be needed for feed-down. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update_optics</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">corrector</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">:</span>
        <span class="n">corrector_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">corrector</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">rdt_comp</span> <span class="ow">in</span> <span class="n">rdt_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rdt_comp</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">rdt_comp</span><span class="o">.</span><span class="n">order</span> <span class="o">&lt;=</span> <span class="n">corrector_order</span> <span class="o">&lt;=</span> <span class="n">rdt_comp</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">feed_down</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Updating the optics is in this configuration not possible,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; as corrector </span><span class="si">{</span><span class="n">corrector</span><span class="si">}</span><span class="s2"> influences </span><span class="si">{</span><span class="n">rdt_comp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; with the given feeddown of </span><span class="si">{</span><span class="n">feed_down</span><span class="si">}</span><span class="s2">. Yet the value of&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; the corrector is defined by </span><span class="si">{</span><span class="n">rdt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_corrector_order_not_lower</span><span class="p">(</span><span class="n">rdt</span><span class="p">,</span> <span class="n">correctors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if only higher and equal order correctors are defined to correct</span>
<span class="sd">    a given rdt.&quot;&quot;&quot;</span>
    <span class="n">wrong_correctors</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">correctors</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">rdt</span><span class="o">.</span><span class="n">order</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_correctors</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Correctors can not correct RDTs of higher order.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Yet for </span><span class="si">{</span><span class="n">rdt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> the corrector(s)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">wrong_correctors</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; was (were) given.&quot;</span>
        <span class="p">)</span>


<span class="c1"># IO Handling ------------------------------------------------------------------</span>
<span class="c1"># Input ---</span>

<span class="k">def</span> <span class="nf">_check_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">:</span> <span class="n">DotDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DotDict</span><span class="p">:</span>
    <span class="c1"># check for unkown input</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>
    <span class="n">known_opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">dest</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_HelpAction</span><span class="p">)]</span>  <span class="c1"># best way I could figure out</span>
    <span class="n">unknown_opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_opts</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_opts</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown arguments found: &#39;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">unknown_opts</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Allowed input parameters are: &#39;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">known_opts</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Set defaults</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">DEFAULTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting input &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to default value &#39;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="n">opt</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>

    <span class="c1"># check accel</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">accel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># let&#39;s not care about case</span>
    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">accel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_RDTS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;accel&#39; needs to be one of &#39;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_RDTS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;but was &#39;</span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">accel</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">)</span>

    <span class="c1"># Set rdts:</span>
    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rdts&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">rdts</span> <span class="o">=</span> <span class="n">DEFAULT_RDTS</span><span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">accel</span><span class="p">]</span>

    <span class="c1"># Check required and rdts:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;optics&#39;</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="s1">&#39;beams&#39;</span><span class="p">,</span> <span class="s1">&#39;rdts&#39;</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">Sized</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is required and needs to be &quot;</span>
                             <span class="s2">&quot;iterable, even if only of length 1. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Instead was &#39;</span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Copy DataFrames as they might be modified</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">optics</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">optics</span><span class="p">]</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">errors</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">feeddown</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;feeddown&#39; needs to be a positive integer.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one iteration (see: &#39;iterations&#39;) needs to &quot;</span>
                         <span class="s2">&quot;be done for correction.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opt</span>


<span class="k">def</span> <span class="nf">get_tfs</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Path</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">read_tfs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;NAME&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span>


<span class="k">def</span> <span class="nf">_check_dfs</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">,</span> <span class="n">beams</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">ignore_missing_columns</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors_dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;A maximum of two optics can be corrected &quot;</span>
                                  <span class="s2">&quot;at the same time, for now.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors_dfs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of given optics (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">) &quot;</span>
                         <span class="s2">&quot;does not equal the number of given error files &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors_dfs</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">). Hint: it should.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">beams</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of given optics (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">) &quot;</span>
                         <span class="s2">&quot;does not equal the number of given beams &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">beams</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">). Please specify a beam for each &quot;</span>
                         <span class="s2">&quot;optics.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx_file</span><span class="p">,</span> <span class="p">(</span><span class="n">optics</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">errors_dfs</span><span class="p">)):</span>
        <span class="n">not_found_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">optics</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_found_errors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;The following elements were found in the &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx2str</span><span class="p">(</span><span class="n">idx_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> given errors file but not in&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;the optics: </span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">not_found_errors</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">not_found_optics</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_found_optics</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The following elements were found in the &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx2str</span><span class="p">(</span><span class="n">idx_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> given optics file but not in &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;the errors: </span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">not_found_optics</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;They are assumed to be zero.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="n">not_found_optics</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">needed_values</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">order</span><span class="o">-</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}{</span><span class="n">orientation</span><span class="si">}</span><span class="s2">L&quot;</span>  <span class="c1"># -1 for madx-order</span>
                         <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span>
                         <span class="k">for</span> <span class="n">orientation</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">file_type</span> <span class="ow">in</span> <span class="p">((</span><span class="n">optics</span><span class="p">,</span> <span class="s2">&quot;optics&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)):</span>
            <span class="n">not_found_strengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">needed_values</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_found_strengths</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Some strength values were not found in the &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx2str</span><span class="p">(</span><span class="n">idx_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> given </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2"> file: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list2str</span><span class="p">(</span><span class="n">not_found_strengths</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_missing_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot; They are assumed to be zero.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kl</span> <span class="ow">in</span> <span class="n">not_found_strengths</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">kl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="switch_signs_for_beam4"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.switch_signs_for_beam4">[docs]</a><span class="k">def</span> <span class="nf">switch_signs_for_beam4</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">],</span>
                           <span class="n">error_dfs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">],</span> <span class="n">beams</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Switch the signs for Beam 4 optics.</span>
<span class="sd">     This is due to the switch in direction for this beam and</span>
<span class="sd">     (anti-) symmetry after a rotation of 180deg around the y-axis of magnets,</span>
<span class="sd">     combined with the fact that the KL values in MAD-X twiss do not change sign,</span>
<span class="sd">     but in the errors they do (otherwise it would compensate).</span>
<span class="sd">     Magnet orders that show anti-symmetry are: a1 (K0SL), b2 (K1L), a3 (K2SL), b4 (K3L) etc.</span>
<span class="sd">     Also the sign for (delta) X is switched back to have the same orientation as beam2.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">optics_df</span><span class="p">,</span> <span class="n">error_df</span><span class="p">,</span> <span class="n">beam</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">optics_dfs</span><span class="p">,</span> <span class="n">error_dfs</span><span class="p">,</span> <span class="n">beams</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beam 4 input found. Switching signs for X and K(S)L values when needed.&quot;</span><span class="p">)</span>
            <span class="n">optics_df</span><span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">optics_df</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>
            <span class="n">error_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">error_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DELTA</span><span class="si">}{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="n">max_order</span> <span class="o">=</span> <span class="n">error_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^K(\d+)S?L$&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">order</span><span class="si">:</span><span class="s2">d</span><span class="si">}{</span><span class="n">SKEW_NAME_MAP</span><span class="p">[</span><span class="n">is_even</span><span class="p">(</span><span class="n">order</span><span class="p">)]</span><span class="si">}</span><span class="s2">L&quot;</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">error_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">error_df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">error_df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<span class="c1"># Output --------</span>

<span class="k">def</span> <span class="nf">get_and_write_output</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">]:</span>
    <span class="n">correction_text</span> <span class="o">=</span> <span class="n">build_correction_str</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span>
    <span class="n">correction_df</span> <span class="o">=</span> <span class="n">build_correction_df</span><span class="p">(</span><span class="n">correctors</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
        <span class="n">write_command</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">correction_text</span><span class="p">)</span>
        <span class="n">write_tfs</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">correction_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">correction_text</span><span class="p">,</span> <span class="n">correction_df</span>


<span class="c1"># Build ---</span>

<span class="k">def</span> <span class="nf">build_correction_df</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">:</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">correctors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cor</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">]</span> <span class="k">for</span> <span class="n">cor</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">build_correction_str</span><span class="p">(</span><span class="n">correctors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_build_correction_str</span><span class="p">(</span><span class="n">corr</span> <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">correctors</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_correction_str_from_df</span><span class="p">(</span><span class="n">correctors_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_build_correction_str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">correctors_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_build_correction_str</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Creates madx commands (assignments) to run for correction&quot;&quot;&quot;</span>
    <span class="n">last_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_types_almost_equal</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">last_type</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!! </span><span class="si">{</span><span class="n">_nice_type</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">field_component</span><span class="si">}</span><span class="s2">) corrector</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">last_type</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">type</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">circuit</span><span class="si">}</span><span class="s2"> := </span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2"> 6E</span><span class="si">}</span><span class="s2"> / l.</span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> ;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_types_almost_equal</span><span class="p">(</span><span class="n">type_a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">type_b</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Groups correctors with and without ending F. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">type_a</span> <span class="o">==</span> <span class="n">type_b</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">type_a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">type_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">type_b</span>
    <span class="k">if</span> <span class="n">type_b</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">type_b</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">type_a</span>


<span class="k">def</span> <span class="nf">_nice_type</span><span class="p">(</span><span class="n">mtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">mtype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mtype</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">[F]&#39;</span>
    <span class="k">return</span> <span class="n">mtype</span>


<span class="c1"># Write ---</span>

<span class="k">def</span> <span class="nf">write_command</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">correction_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">out_path_cmd</span> <span class="o">=</span> <span class="n">out_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">EXT_MADX</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path_cmd</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">correction_text</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_tfs</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">correction_df</span><span class="p">:</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">):</span>
    <span class="n">out_path_df</span> <span class="o">=</span> <span class="n">out_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">EXT_TFS</span><span class="p">)</span>
    <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path_df</span><span class="p">,</span> <span class="n">correction_df</span><span class="p">)</span>


<span class="c1"># Helper -----------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">list2str</span><span class="p">(</span><span class="n">list_</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">idx2str</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;third&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;fourth&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;fifth&#39;</span><span class="p">}[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">order2field_component</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">skew</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SKEW_FIELD_MAP</span><span class="p">[</span><span class="n">skew</span><span class="p">]</span><span class="si">:</span><span class="s2">s</span><span class="si">}{</span><span class="n">order</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">field_component2order</span><span class="p">(</span><span class="n">field_component</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">field_component</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">FIELD_SKEW_MAP</span><span class="p">[</span><span class="n">field_component</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">is_odd</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_even</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">is_odd</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">i_pow</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span><span class="n">j</span><span class="o">**</span><span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>   <span class="c1"># more exact with modulo</span>


<span class="c1"># Script Mode ------------------------------------------------------------------</span>


<div class="viewcode-block" id="log_setup"><a class="viewcode-back" href="../../entrypoints/irnl_rdt_correction.html#pylhc.irnl_rdt_correction.log_setup">[docs]</a><span class="k">def</span> <span class="nf">log_setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Set up a basic logger. &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)7s</span><span class="s2"> | </span><span class="si">%(message)s</span><span class="s2"> | </span><span class="si">%(name)s</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">log_setup</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>