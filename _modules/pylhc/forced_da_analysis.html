<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pylhc.forced_da_analysis &mdash; pylhc 0.2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/omc_logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Entrypoints</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/analysis.html">Analysis Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#bsrt-analysis">BSRT Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#forced-da-analysis">Forced DA Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/bpm_calibration.html">BPM Calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/bpm_calibration.html#id1">BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/irnl_rdt_correction.html">IRNL RDT Correction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/irnl_rdt_correction.html#nonlinear-correction-calculation-in-the-irs">Nonlinear Correction calculation in the IRs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/machine_info.html">Machine Information Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/machine_info.html#print-machine-settings-overview">Print Machine Settings Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/machine_info.html#bsrt-logger">BSRT logger</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/calibration.html">BPM Calibration Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#beta">Beta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#dispersion">Dispersion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/constants.html">Constants Definitions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-general">Constants: General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-forced-da-analysis">Constants: Forced DA Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-machine-settings-info">Constants: Machine Settings Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-bpm-calibration">Constants: BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/data_extract.html">Data Extraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#pylsa">PyLSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#timber">Timber</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/utils.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/utils.html#additional-io-tools">Additional IO-Tools</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pylhc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>pylhc.forced_da_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pylhc.forced_da_analysis</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Forced DA Analysis</span>
<span class="sd">------------------</span>

<span class="sd">Top-level script to run the forced DA analysis, following the procedure described in</span>
<span class="sd">`CarlierForcedDA2019`_.</span>

<span class="sd">Arguments:</span>

<span class="sd">*--Required--*</span>

<span class="sd">- **beam** *(int)*: Beam to use.</span>

<span class="sd">  Flags: **[&#39;-b&#39;, &#39;--beam&#39;]**</span>
<span class="sd">  Choices: ``[1, 2]``</span>
<span class="sd">- **energy** *(MultiClass)*: Beam energy in GeV.</span>

<span class="sd">  Flags: **[&#39;-e&#39;, &#39;--energy&#39;]**</span>
<span class="sd">- **kick_directory** *(MultiClass)*: Analysis kick_directory containing kick files.</span>

<span class="sd">  Flags: **[&#39;-k&#39;, &#39;--kickdir&#39;]**</span>
<span class="sd">- **plane** *(str)*: Plane of the kicks.</span>

<span class="sd">  Flags: **[&#39;-p&#39;, &#39;--plane&#39;]**</span>
<span class="sd">  Choices: ``[&#39;X&#39;, &#39;Y&#39;]``</span>

<span class="sd">*--Optional--*</span>

<span class="sd">- **emittance_outlier_limit** *(float)*: Limit, i.e. cut from mean, on emittance outliers in meter.</span>

<span class="sd">  Default: ``5e-07``</span>
<span class="sd">- **emittance_tfs** *(MultiClass)*: Dataframe or Path of pre-saved emittance tfs.</span>

<span class="sd">- **emittance_type** *(str)*: Which BSRT data to use (from database).</span>

<span class="sd">  Choices: ``[&#39;fit_sigma&#39;, &#39;average&#39;]``</span>
<span class="sd">  Default: ``average``</span>
<span class="sd">- **emittance_window_length** *(int)*: Length of the moving average window. (# data points)</span>

<span class="sd">  Default: ``100``</span>
<span class="sd">- **fill** *(int)*: Fill that was used. If not given, check out time_around_kicks.</span>

<span class="sd">  Flags: **[&#39;-f&#39;, &#39;--fill&#39;]**</span>
<span class="sd">- **fit** *(str)*: Fitting function to use (rearranges parameters to make sense).</span>

<span class="sd">  Choices: ``[&#39;exponential&#39;, &#39;linear&#39;]``</span>
<span class="sd">  Default: ``exponential``</span>
<span class="sd">- **intensity_tfs** *(MultiClass)*: Dataframe or Path of pre-saved intensity tfs.</span>

<span class="sd">- **intensity_time_after_kick** *(int)*: Defines the times after the kicks (in seconds) which is used for intensity averaging to calculate the losses.</span>

<span class="sd">  Default: ``[5, 30]``</span>
<span class="sd">- **intensity_time_before_kick** *(int)*: Defines the times before the kicks (in seconds) which is used for intensity averaging to calculate the losses.</span>

<span class="sd">  Default: ``[30, 5]``</span>
<span class="sd">- **normalized_emittance** *(float)*: Assumed NORMALIZED nominal emittance for the machine.</span>

<span class="sd">  Default: ``3.7499999999999997e-06``</span>
<span class="sd">- **output_directory** *(MultiClass)*: Output kick_directory, if not given subfolder in kick kick_directory</span>

<span class="sd">  Flags: **[&#39;-o&#39;, &#39;--outdir&#39;]**</span>
<span class="sd">- **pagestore_db** *(MultiClass)*: (Path to-) presaved timber database</span>

<span class="sd">- **show**: Show plots.</span>

<span class="sd">  Action: ``store_true``</span>
<span class="sd">- **show_wirescan_emittance** *(BoolOrPathOrDataFrame)*: Flag if the emittance from wirescan should also be shown, can also be a Dataframe or Path of pre-saved emittance bws tfs.</span>

<span class="sd">  Default: ``False``</span>
<span class="sd">- **timber_db** *(str)*: Which timber database to use.</span>

<span class="sd">  Choices: ``[&#39;all&#39;, &#39;mdb&#39;, &#39;ldb&#39;, &#39;nxcals&#39;]``</span>
<span class="sd">  Default: ``all``</span>
<span class="sd">- **time_around_kicks** *(int)*: If no fill is given, this defines the time (in minutes) when data before the first and after the last kick is extracted.</span>

<span class="sd">  Default: ``10``</span>
<span class="sd">- **plot_styles** *(str)*: Which plotting styles to use,</span>
<span class="sd">  either from omc3 styles or default mpl.</span>

<span class="sd">  Default: ``[&#39;standard&#39;]``</span>
<span class="sd">- **manual_style** *(DictAsString)*: Additional style rcParameters which update the set of predefined ones.</span>

<span class="sd">  Default: ``{}``</span>


<span class="sd">:author: jdilly</span>

<span class="sd">.. _CarlierForcedDA2019: https://journals.aps.org/prab/pdf/10.1103/PhysRevAccelBeams.22.031002</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">mtrans</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.odr</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">tfs</span>
<span class="kn">from</span> <span class="nn">generic_parser</span> <span class="kn">import</span> <span class="n">EntryPointParameters</span><span class="p">,</span> <span class="n">entrypoint</span>
<span class="kn">from</span> <span class="nn">generic_parser.entry_datatypes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DictAsString</span><span class="p">,</span>
    <span class="n">FALSE_ITEMS</span><span class="p">,</span>
    <span class="n">TRUE_ITEMS</span><span class="p">,</span>
    <span class="n">get_instance_faker_meta</span><span class="p">,</span>
    <span class="n">get_multi_class</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">generic_parser.tools</span> <span class="kn">import</span> <span class="n">DotDict</span>
<span class="kn">from</span> <span class="nn">omc3.optics_measurements</span> <span class="kn">import</span> <span class="n">toolbox</span>
<span class="kn">from</span> <span class="nn">omc3.plotting.utils</span> <span class="kn">import</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">style</span>
<span class="kn">from</span> <span class="nn">omc3.tune_analysis.bbq_tools</span> <span class="kn">import</span> <span class="n">clean_outliers_moving_average</span>
<span class="kn">from</span> <span class="nn">omc3.utils</span> <span class="kn">import</span> <span class="n">logging_tools</span>
<span class="kn">from</span> <span class="nn">omc3.utils.iotools</span> <span class="kn">import</span> <span class="n">save_config</span>
<span class="kn">from</span> <span class="nn">omc3.utils.mock</span> <span class="kn">import</span> <span class="n">cern_network_import</span>
<span class="kn">from</span> <span class="nn">omc3.utils.time_tools</span> <span class="kn">import</span> <span class="n">CERNDatetime</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">from</span> <span class="nn">pandas.plotting</span> <span class="kn">import</span> <span class="n">register_matplotlib_converters</span>
<span class="kn">from</span> <span class="nn">tfs</span> <span class="kn">import</span> <span class="n">TfsDataFrame</span>
<span class="kn">from</span> <span class="nn">tfs.tools</span> <span class="kn">import</span> <span class="n">significant_digits</span>

<span class="n">pytimber</span> <span class="o">=</span> <span class="n">cern_network_import</span><span class="p">(</span><span class="s1">&#39;pytimber&#39;</span><span class="p">)</span>
<span class="n">PageStore</span> <span class="o">=</span> <span class="n">cern_network_import</span><span class="p">(</span><span class="s1">&#39;pytimber.pagestore.PageStore&#39;</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">pylhc.constants.forced_da_analysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BSRT_EMITTANCE_TO_METER</span><span class="p">,</span>
    <span class="n">BWS_DIRECTIONS</span><span class="p">,</span>
    <span class="n">BWS_EMITTANCE_TO_METER</span><span class="p">,</span>
    <span class="n">HEADER_BSRT_OUTLIER_LIMIT</span><span class="p">,</span>
    <span class="n">HEADER_BSRT_ROLLING_WINDOW</span><span class="p">,</span>
    <span class="n">HEADER_ENERGY</span><span class="p">,</span>
    <span class="n">HEADER_TIME_AFTER</span><span class="p">,</span>
    <span class="n">HEADER_TIME_BEFORE</span><span class="p">,</span>
    <span class="n">INITIAL_DA_FIT</span><span class="p">,</span>
    <span class="n">INTENSITY</span><span class="p">,</span>
    <span class="n">INTENSITY_AFTER</span><span class="p">,</span>
    <span class="n">INTENSITY_BEFORE</span><span class="p">,</span>
    <span class="n">INTENSITY_KEY</span><span class="p">,</span>
    <span class="n">INTENSITY_LOSSES</span><span class="p">,</span>
    <span class="n">KICKFILE</span><span class="p">,</span>
    <span class="n">MAX_CURVEFIT_FEV</span><span class="p">,</span>
    <span class="n">OUTFILE_INTENSITY</span><span class="p">,</span>
    <span class="n">OUTLIER_LIMIT</span><span class="p">,</span>
    <span class="n">PLOT_FILETYPES</span><span class="p">,</span>
    <span class="n">RESULTS_DIR</span><span class="p">,</span>
    <span class="n">ROLLING_AVERAGE_WINDOW</span><span class="p">,</span>
    <span class="n">TIME_AFTER_KICK_S</span><span class="p">,</span>
    <span class="n">TIME_AROUND_KICKS_MIN</span><span class="p">,</span>
    <span class="n">TIME_BEFORE_KICK_S</span><span class="p">,</span>
    <span class="n">YPAD</span><span class="p">,</span>
    <span class="n">bsrt_emittance_key</span><span class="p">,</span>
    <span class="n">bws_emittance_key</span><span class="p">,</span>
    <span class="n">column_action</span><span class="p">,</span>
    <span class="n">column_bws_norm_emittance</span><span class="p">,</span>
    <span class="n">column_emittance</span><span class="p">,</span>
    <span class="n">column_norm_emittance</span><span class="p">,</span>
    <span class="n">err_col</span><span class="p">,</span>
    <span class="n">header_da</span><span class="p">,</span>
    <span class="n">header_da_error</span><span class="p">,</span>
    <span class="n">header_nominal_emittance</span><span class="p">,</span>
    <span class="n">header_norm_nominal_emittance</span><span class="p">,</span>
    <span class="n">mean_col</span><span class="p">,</span>
    <span class="n">outfile_emittance</span><span class="p">,</span>
    <span class="n">outfile_emittance_bws</span><span class="p">,</span>
    <span class="n">outfile_kick</span><span class="p">,</span>
    <span class="n">outfile_plot</span><span class="p">,</span>
    <span class="n">rel_col</span><span class="p">,</span>
    <span class="n">sigma_col</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pylhc.constants.general</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LHC_NOMINAL_EMITTANCE</span><span class="p">,</span>
    <span class="n">TFS_SUFFIX</span><span class="p">,</span>
    <span class="n">TIME_COLUMN</span><span class="p">,</span>
    <span class="n">get_proton_beta</span><span class="p">,</span>
    <span class="n">get_proton_gamma</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging_tools</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Weird Datatypes</span>
<div class="viewcode-block" id="BoolOrPathOrDataFrame"><a class="viewcode-back" href="../../entrypoints/analysis.html#pylhc.forced_da_analysis.BoolOrPathOrDataFrame">[docs]</a><span class="k">class</span> <span class="nc">BoolOrPathOrDataFrame</span><span class="p">(</span>
    <span class="n">metaclass</span><span class="o">=</span><span class="n">get_instance_faker_meta</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that behaves like a `boolean` when possible, otherwise like a `Path`, `string` or</span>
<span class="sd">    `Dataframe`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># behavior like dict-parser</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">TRUE_ITEMS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FALSE_ITEMS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span></div>


<span class="k">def</span> <span class="nf">_get_pathclass</span><span class="p">(</span><span class="o">*</span><span class="n">other_classes</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">SomethingOrPath</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">get_instance_faker_meta</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">other_classes</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
        <span class="sd">&quot;&quot;&quot;A class that behaves like a if possible `Path`, `string` or something else.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Needs to be done for strings in config-files</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">SomethingOrPath</span>


<span class="n">PathOrDataframe</span> <span class="o">=</span> <span class="n">_get_pathclass</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
<span class="n">PathOrPagestore</span> <span class="o">=</span> <span class="n">_get_pathclass</span><span class="p">(</span><span class="n">PageStore</span><span class="p">)</span>
<span class="n">PathOrString</span> <span class="o">=</span> <span class="n">_get_pathclass</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_params</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">EntryPointParameters</span><span class="p">(</span>
        <span class="n">kick_directory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="s2">&quot;--kickdir&quot;</span><span class="p">],</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">PathOrString</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Analysis kick_directory containing kick files.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">output_directory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--outdir&quot;</span><span class="p">],</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">PathOrString</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output kick_directory, if not given subfolder in kick kick_directory&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">energy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--energy&quot;</span><span class="p">],</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">get_multi_class</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Beam energy in GeV.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">fill</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--fill&quot;</span><span class="p">],</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">get_multi_class</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fill that was used. If not given, check out time_around_kicks.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">beam</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--beam&quot;</span><span class="p">],</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Beam to use.&quot;</span>
        <span class="p">),</span>
        <span class="n">plane</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--plane&quot;</span><span class="p">],</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Plane of the kicks.&quot;</span>
                <span class="c1"># &quot; Give &#39;XY&#39; for using both planes (e.g. diagonal kicks).&quot;  # Future release</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">time_around_kicks</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">TIME_AROUND_KICKS_MIN</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;If no fill is given, this defines the time (in minutes) &quot;</span>
                <span class="s2">&quot;when data before the first and after the last kick is extracted.&quot;</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">intensity_time_before_kick</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">TIME_BEFORE_KICK_S</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Defines the times before the kicks (in seconds) &quot;</span>
                <span class="s2">&quot;which is used for intensity averaging to calculate the losses.&quot;</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">intensity_time_after_kick</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">TIME_AFTER_KICK_S</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Defines the times after the kicks (in seconds) &quot;</span>
                <span class="s2">&quot;which is used for intensity averaging to calculate the losses.&quot;</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">normalized_emittance</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">LHC_NOMINAL_EMITTANCE</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Assumed NORMALIZED nominal emittance for the machine.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">emittance_tfs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">PathOrDataframe</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataframe or Path of pre-saved emittance tfs.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">intensity_tfs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">PathOrDataframe</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataframe or Path of pre-saved intensity tfs.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">show_wirescan_emittance</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">BoolOrPathOrDataFrame</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Flag if the emittance from wirescan should also be shown, &quot;</span>
                <span class="s2">&quot;can also be a Dataframe or Path of pre-saved emittance bws tfs.&quot;</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">timber_db</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;mdb&quot;</span><span class="p">,</span> <span class="s2">&quot;ldb&quot;</span><span class="p">,</span> <span class="s2">&quot;nxcals&quot;</span><span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which timber database to use.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">pagestore_db</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">PathOrPagestore</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Path to-) presaved timber database&quot;</span><span class="p">),</span>
        <span class="n">fit</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;exponential&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fitting function to use (rearranges parameters to make sense).&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">emittance_window_length</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Length of the moving average window. (# data points)&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">ROLLING_AVERAGE_WINDOW</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">emittance_outlier_limit</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Limit, i.e. cut from mean, on emittance outliers in meter.&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">OUTLIER_LIMIT</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">emittance_type</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fit_sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which BSRT data to use (from database).&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">show</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show plots.&quot;</span><span class="p">,),</span>
        <span class="n">plot_styles</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;standard&quot;</span><span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which plotting styles to use, either from omc3 styles or default mpl.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">manual_style</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">DictAsString</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Additional style rcParameters which update the set of predefined ones.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="nd">@entrypoint</span><span class="p">(</span><span class="n">get_params</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting Forced DA analysis.&quot;</span><span class="p">)</span>
    <span class="n">_log_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="n">kick_dir</span><span class="p">,</span> <span class="n">out_dir</span> <span class="o">=</span> <span class="n">_get_output_dir</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">kick_directory</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">):</span>
        <span class="n">save_config</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">)</span>

    <span class="c1"># get data</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_get_kick_df</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">intensity_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span> <span class="o">=</span> <span class="n">_get_dataframes</span><span class="p">(</span>
        <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">get_subdict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;fill&quot;</span><span class="p">,</span>
                <span class="s2">&quot;beam&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plane&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_around_kicks&quot;</span><span class="p">,</span>
                <span class="s2">&quot;emittance_tfs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_tfs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;show_wirescan_emittance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timber_db&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pagestore_db&quot;</span><span class="p">,</span>
                <span class="s2">&quot;emittance_window_length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;emittance_outlier_limit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;emittance_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;normalized_emittance&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">_check_all_times_in</span><span class="p">(</span><span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># add data to kicks</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_add_intensity_and_losses_to_kicks</span><span class="p">(</span>
        <span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">intensity_time_before_kick</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">intensity_time_after_kick</span>
    <span class="p">)</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_add_emittance_to_kicks</span><span class="p">(</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">normalized_emittance</span>
    <span class="p">)</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_do_fit</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">fit</span><span class="p">)</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_convert_to_sigmas</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">)</span>

    <span class="c1"># output</span>
    <span class="n">_write_tfs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span><span class="p">)</span>

    <span class="c1"># plotting</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">register_matplotlib_converters</span><span class="p">()</span>  <span class="c1"># for datetime plotting</span>
    <span class="n">style</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">plot_styles</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">manual_style</span><span class="p">)</span>
    <span class="n">figs</span><span class="p">[</span><span class="s2">&quot;emittance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_plot_emittances</span><span class="p">(</span>
        <span class="n">out_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span><span class="p">,</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">figs</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_plot_intensity</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fit_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;norm&quot;</span><span class="p">):</span>
        <span class="n">figs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;da_fit_</span><span class="si">{</span><span class="n">fit_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_plot_da_fit</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Forced DA analysis finished.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figs</span>


<span class="c1"># Helper ---</span>


<span class="k">def</span> <span class="nf">_log_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">:</span> <span class="n">DotDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show options in log.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing ForcedDA Analysis for:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fill: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">fill</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Energy: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2"> GeV&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Beam: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Plane: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Analysis Directory: &#39;</span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">kick_directory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_write_tfs</span><span class="p">(</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">plane</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">kick_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">intensity_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">emittance_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">emittance_bws_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write out gathered data.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing tfs files.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TIME_COLUMN</span><span class="p">,</span> <span class="p">[</span><span class="n">CERNDatetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">cern_utc_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">outfile_kick</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">kick_df</span><span class="p">)</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">OUTFILE_INTENSITY</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">)</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">outfile_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">emittance_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">emittance_bws_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">outfile_emittance_bws</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">emittance_bws_df</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot write into directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_all_times_in</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">CERNDatetime</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">CERNDatetime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if all times in series are between start and end.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Some of the kick-times are outside of the fill times! &quot;</span>
            <span class="s2">&quot;Check if correct kick-file or fill number are used.&quot;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert_time_index</span><span class="p">(</span><span class="n">list_</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Tries to convert time index to cerntime, first from datetime, then string, then timestamp.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">index_convert</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">_datetime_to_cerntime_index</span><span class="p">,</span>
        <span class="n">_string_to_cerntime_index</span><span class="p">,</span>
        <span class="n">_timestamp_to_cerntime_index</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index_convert</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unrecognized format in column &#39;</span><span class="si">{</span><span class="n">TIME_COLUMN</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; in &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_string_to_cerntime_index</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">((</span><span class="n">CERNDatetime</span><span class="o">.</span><span class="n">from_cern_utc_string</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_timestamp_to_cerntime_index</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">((</span><span class="n">CERNDatetime</span><span class="o">.</span><span class="n">from_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_datetime_to_cerntime_index</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">((</span><span class="n">CERNDatetime</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_drop_duplicate_indices</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">duplicate_mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">duplicate_mask</span><span class="p">,</span> <span class="p">:]</span>


<span class="c1"># TFS Data Loading -------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_get_dataframes</span><span class="p">(</span>
    <span class="n">kick_times</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="n">DotDict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TfsDataFrame</span><span class="p">,</span> <span class="n">TfsDataFrame</span><span class="p">,</span> <span class="n">TfsDataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the intensity and emittance dataframes from either input, files or (timber) database.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">_get_db</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timespan_ts</span> <span class="o">=</span> <span class="n">_get_fill_times</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">fill</span><span class="p">)</span>
        <span class="n">timespan_dt</span> <span class="o">=</span> <span class="n">_convert_time_index</span><span class="p">(</span><span class="n">timespan_ts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">td</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">time_around_kicks</span><span class="p">)</span>
        <span class="n">timespan_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">kick_times</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">td</span><span class="p">,</span> <span class="n">kick_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">td</span><span class="p">)</span>
        <span class="n">timespan_ts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timespan_dt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">intensity_tfs</span><span class="p">:</span>
        <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">_read_tfs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">intensity_tfs</span><span class="p">,</span> <span class="n">timespan_dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">_get_bctrf_beam_intensity_from_timber</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan_ts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">emittance_tfs</span><span class="p">:</span>
        <span class="n">emittance_df</span> <span class="o">=</span> <span class="n">_read_tfs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">emittance_tfs</span><span class="p">,</span> <span class="n">timespan_dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">emittance_df</span> <span class="o">=</span> <span class="n">_get_bsrt_bunch_emittances_from_timber</span><span class="p">(</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan_ts</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">emittance_type</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">normalized_emittance</span>
        <span class="p">)</span>
    <span class="n">emittance_df</span> <span class="o">=</span> <span class="n">_filter_emittance_data</span><span class="p">(</span>
        <span class="n">emittance_df</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">emittance_window_length</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">emittance_outlier_limit</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">show_wirescan_emittance</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">emittance_bws_df</span> <span class="o">=</span> <span class="n">_get_bws_emittances_from_timber</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">plane</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan_ts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">show_wirescan_emittance</span><span class="p">:</span>
        <span class="n">emittance_bws_df</span> <span class="o">=</span> <span class="n">_read_tfs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">show_wirescan_emittance</span><span class="p">,</span> <span class="n">timespan_dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">emittance_bws_df</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span>


<span class="k">def</span> <span class="nf">_read_tfs</span><span class="p">(</span><span class="n">tfs_file_or_path</span><span class="p">,</span> <span class="n">timespan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read previously gathered data (see :meth:`pylhc.forced_da_analysis._write_tfs`).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tfs_df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read_tfs</span><span class="p">(</span><span class="n">tfs_file_or_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">TIME_COLUMN</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">tfs_df</span> <span class="o">=</span> <span class="n">tfs_file_or_path</span>  <span class="c1"># hopefully</span>

    <span class="n">tfs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">_convert_time_index</span><span class="p">(</span><span class="n">tfs_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">timespan</span><span class="p">),</span> <span class="p">:]</span>


<span class="k">def</span> <span class="nf">_filter_emittance_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cleans emittance data via outlier filter and moving average.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering emittance data in plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">col_nemittance</span> <span class="o">=</span> <span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
        <span class="c1"># col_err_nemittance = err_col(col_nemittance)</span>
        <span class="n">col_mean</span> <span class="o">=</span> <span class="n">mean_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">)</span>
        <span class="n">col_err_mean</span> <span class="o">=</span> <span class="n">err_col</span><span class="p">(</span><span class="n">col_mean</span><span class="p">)</span>

        <span class="n">mav</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">clean_outliers_moving_average</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col_nemittance</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">window_length</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_mean</span><span class="p">]</span> <span class="o">=</span> <span class="n">mav</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_err_mean</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span>
        <span class="c1"># if any(df[col_err_nemittance]):</span>
        <span class="c1">#     df[col_err_mean] = _rolling_errors(df[col_err_nemittance], ~mask, window_length)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Not enough emittance data extracted. Try to give a fill number.&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_BSRT_ROLLING_WINDOW</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_length</span>
    <span class="n">df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_BSRT_OUTLIER_LIMIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">_maybe_add_sum_for_planes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">column_norm_emittance</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">_maybe_add_sum_for_planes</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">planes</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">mean_col</span><span class="p">(</span><span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">err_col</span><span class="p">(</span><span class="n">mean_col</span><span class="p">(</span><span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">p</span><span class="p">))),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="c1"># Timber Data ------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_get_db</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the database either presaved or from timber.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">pagestore_db</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">pagestore_db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading database from file </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">PageStore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;&#39;fill&#39; can&#39;t be used with pagestore database.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying to load database from timber.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">pytimber</span><span class="o">.</span><span class="n">LoggingDB</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;timber_db&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Loading from timber failed.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;&#39;fill&#39; is given, &quot;</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">emittance_tfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;&#39;emittance_tfs&#39; is not given, &quot;</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">intensity_tfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;&#39;intensity_tfs&#39; is not given, &quot;</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">show_wirescan_emittance</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;wirescan emittance is requested, &quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_msg</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;but there is no database given and no access to timber databases. Aborting.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>


<span class="k">def</span> <span class="nf">_get_fill_times</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">fill</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract Fill times from database.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting Timespan from fill </span><span class="si">{</span><span class="n">fill</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filldata</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">getLHCFillData</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filldata</span><span class="p">[</span><span class="s2">&quot;startTime&quot;</span><span class="p">],</span> <span class="n">filldata</span><span class="p">[</span><span class="s2">&quot;endTime&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_bctrf_beam_intensity_from_timber</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting beam intensity from bctfr for beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">intensity_key</span> <span class="o">=</span> <span class="n">INTENSITY_KEY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="n">beam</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Key: </span><span class="si">{</span><span class="n">intensity_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">intensity_key</span><span class="p">,</span> <span class="o">*</span><span class="n">timespan</span><span class="p">)[</span><span class="n">intensity_key</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">_timestamp_to_cerntime_index</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">INTENSITY</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">_drop_duplicate_indices</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Returning dataframe of shape </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_get_bsrt_bunch_emittances_from_timber</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">nominal_emittance</span><span class="p">):</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting emittance from BSRT for beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">  and plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">bunch_emittance_key</span> <span class="o">=</span> <span class="n">bsrt_emittance_key</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">key_type</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Key: </span><span class="si">{</span><span class="n">bunch_emittance_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">col_nemittance</span> <span class="o">=</span> <span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
        <span class="n">all_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="n">mean_col</span><span class="p">,</span> <span class="n">err_col</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">err_col</span><span class="p">(</span><span class="n">mean_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bunch_emittance_key</span><span class="p">,</span> <span class="o">*</span><span class="n">timespan</span><span class="p">)[</span><span class="n">bunch_emittance_key</span><span class="p">]</span>
        <span class="n">y_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s2">&quot;fit_sigma&quot;</span><span class="p">:</span>
            <span class="c1"># add all data with the same timestamp</span>
            <span class="n">y_new</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x_elem</span><span class="p">,</span> <span class="n">y_elem</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="n">y_new</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_elem</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_elem</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># get average and std per timestamp</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">y_new</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">y_new</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="o">*</span> <span class="n">nominal_emittance</span>
            <span class="n">y_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">y_new</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="o">*</span> <span class="n">nominal_emittance</span>
        <span class="k">elif</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="n">BSRT_EMITTANCE_TO_METER</span>
            <span class="n">y_std</span> <span class="o">*=</span> <span class="n">BSRT_EMITTANCE_TO_METER</span>

        <span class="c1"># remove entries with zero emittance as unphysical</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_std</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_std</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">_timestamp_to_cerntime_index</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_nemittance</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">)]</span> <span class="o">=</span> <span class="n">y_std</span>

        <span class="n">dfs</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">_merge_df_planes</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Returning dataframe of shape </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_get_bws_emittances_from_timber</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">timespan</span><span class="p">):</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting emittance from BWS for beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2"> and plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">all_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_bws_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">BWS_DIRECTIONS</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">BWS_DIRECTIONS</span><span class="p">:</span>
            <span class="n">emittance_key</span> <span class="o">=</span> <span class="n">bws_emittance_key</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Key: </span><span class="si">{</span><span class="n">emittance_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">column_nemittance</span> <span class="o">=</span> <span class="n">column_bws_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">emittance_key</span><span class="p">,</span> <span class="o">*</span><span class="n">timespan</span><span class="p">)[</span><span class="n">emittance_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">_timestamp_to_cerntime_index</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
                <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column_nemittance</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">BWS_EMITTANCE_TO_METER</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column_nemittance</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_nemittance</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
            <span class="p">)</span>  <span class="c1"># BWS can give multiple values</span>
            <span class="n">df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">column_nemittance</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_nemittance</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">std</span>
            <span class="p">)</span>  <span class="c1"># BWS can give multiple values</span>
            <span class="n">dfs</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">_merge_df_planes</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">BWS_DIRECTIONS</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_maybe_add_sum_for_planes</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">planes</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">column_bws_norm_emittance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">direction</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">err_col</span><span class="p">(</span><span class="n">column_bws_norm_emittance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">direction</span><span class="p">)),</span>
        <span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Returning dataframe of shape </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="c1"># Kick Data --------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_get_kick_df</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">column_action_error</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">err_col</span><span class="p">(</span><span class="n">column_action</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_get_new_kick_file</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading of kickfile failed. Looking for old kickfile.&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_get_old_kick_file</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">_maybe_add_sum_for_planes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">column_action</span><span class="p">,</span> <span class="n">column_action_error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="n">column_action</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">column_action_error</span><span class="p">(</span><span class="n">plane</span><span class="p">)]]</span>


<span class="k">def</span> <span class="nf">_get_old_kick_file</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Kick files from ``Beta-Beat.src``.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">kick_dir</span> <span class="o">/</span> <span class="s2">&quot;getkickac.out&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading kickfile &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;.&#39;&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">TIME_COLUMN</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">_convert_time_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plane</span><span class="p">:</span>  <span class="c1"># can be XY</span>
        <span class="n">rename_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;2J</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">RES&quot;</span><span class="p">:</span> <span class="n">column_action</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                <span class="sa">f</span><span class="s2">&quot;2J</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">STDRES&quot;</span><span class="p">:</span> <span class="n">err_col</span><span class="p">(</span><span class="n">column_action</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>
                <span class="sa">f</span><span class="s2">&quot;J</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">:</span> <span class="n">column_action</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>  <span class="c1"># pre 2017</span>
                <span class="sa">f</span><span class="s2">&quot;J</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">STD&quot;</span><span class="p">:</span> <span class="n">err_col</span><span class="p">(</span><span class="n">column_action</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>  <span class="c1"># pre 2017</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_dict</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="n">renamed_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">renamed_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">renamed_cols</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_get_new_kick_file</span><span class="p">(</span><span class="n">kick_dir</span><span class="p">,</span> <span class="n">planes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Kick files from ``omc3``.&quot;&quot;&quot;</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">kick_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">KICKFILE</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plane</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}{</span><span class="n">TFS_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading kickfile &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;.&#39;&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">TIME_COLUMN</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="n">CERNDatetime</span><span class="o">.</span><span class="n">from_cern_utc_string</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">return</span> <span class="n">_merge_df_planes</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_output_dir</span><span class="p">(</span><span class="n">kick_directory</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">):</span>
    <span class="n">kick_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">kick_directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_directory</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">kick_path</span> <span class="o">/</span> <span class="n">RESULTS_DIR</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;You have no writing permission in &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;output data might not be created.&quot;</span>
        <span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All output will be written to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kick_path</span><span class="p">,</span> <span class="n">output_path</span>


<span class="c1"># Intensity at Kicks -----------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_add_intensity_and_losses_to_kicks</span><span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">time_before</span><span class="p">,</span> <span class="n">time_after</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating intensity and losses for the kicks.&quot;</span><span class="p">)</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">,</span> <span class="n">INTENSITY_AFTER</span><span class="p">,</span> <span class="n">INTENSITY_LOSSES</span><span class="p">]</span>
    <span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">]]</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">kick_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">new_columns</span><span class="p">)</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_get_intensities_around_kicks</span><span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">time_before</span><span class="p">,</span> <span class="n">time_after</span><span class="p">)</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">_calculate_intensity_losses_at_kicks</span><span class="p">(</span><span class="n">kick_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kick_df</span>


<span class="k">def</span> <span class="nf">_get_intensities_around_kicks</span><span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">,</span> <span class="n">time_before</span><span class="p">,</span> <span class="n">time_after</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating beam intensity before and after kicks.&quot;</span><span class="p">)</span>
    <span class="c1"># input signs and order does not matter</span>
    <span class="n">time_before</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_before</span><span class="p">)</span>
    <span class="n">time_after</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_after</span><span class="p">)</span>

    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_TIME_BEFORE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_before</span><span class="p">)</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_TIME_AFTER</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_after</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="c1"># calculate intensity before and after kicks (with error)</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">time_delta</span> <span class="ow">in</span> <span class="p">((</span><span class="n">INTENSITY_BEFORE</span><span class="p">,</span> <span class="n">time_before</span><span class="p">),</span> <span class="p">(</span><span class="n">INTENSITY_AFTER</span><span class="p">,</span> <span class="n">time_after</span><span class="p">)):</span>
            <span class="n">t_from</span><span class="p">,</span> <span class="n">t_to</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">t_from</span><span class="p">:</span><span class="n">t_to</span><span class="p">,</span> <span class="n">INTENSITY</span>
            <span class="p">]</span>  <span class="c1"># awesome pandas can handle time intervals!</span>
            <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="p">[</span><span class="n">column</span><span class="p">,</span> <span class="n">err_col</span><span class="p">(</span><span class="n">column</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kick_df</span>


<span class="k">def</span> <span class="nf">_calculate_intensity_losses_at_kicks</span><span class="p">(</span><span class="n">kick_df</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating intensity losses.&quot;</span><span class="p">)</span>
    <span class="c1"># absolute losses</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_LOSSES</span><span class="p">]</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">]</span> <span class="o">-</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_AFTER</span><span class="p">]</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_BEFORE</span><span class="p">)])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_AFTER</span><span class="p">)])</span>
    <span class="p">)</span>

    <span class="c1"># relative losses, error from error-propagation formular for losses / I_before = 1 - I_after / I_before</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">rel_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_LOSSES</span><span class="p">]</span> <span class="o">/</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">]</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">rel_col</span><span class="p">(</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_AFTER</span><span class="p">]</span> <span class="o">/</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">])</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_AFTER</span><span class="p">)]</span> <span class="o">/</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_AFTER</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_BEFORE</span><span class="p">)]</span> <span class="o">/</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">kick_df</span>


<span class="c1"># Emittance at Kicks -----------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_add_emittance_to_kicks</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">nominal</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving normalized emittance at the kicks.&quot;</span><span class="p">)</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_ENERGY</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">HEADER_BSRT_ROLLING_WINDOW</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROLLING_AVERAGE_WINDOW</span>
    <span class="n">col_nemittance</span> <span class="o">=</span> <span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">cols_emitt</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">),</span> <span class="n">err_col</span><span class="p">(</span><span class="n">mean_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">))]</span>
    <span class="n">cols_kick</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_nemittance</span><span class="p">,</span> <span class="n">err_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">)]</span>

    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">kick_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">cols_kick</span><span class="p">)</span>
    <span class="n">idx_emitt</span> <span class="o">=</span> <span class="p">[</span><span class="n">emittance_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_emitt</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">idx_kick</span> <span class="o">=</span> <span class="n">emittance_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="n">cols_kick</span><span class="p">]</span> <span class="o">=</span> <span class="n">emittance_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_kick</span><span class="p">,</span> <span class="n">idx_emitt</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># add de-normalized emittance</span>
    <span class="n">normalization</span> <span class="o">=</span> <span class="n">get_proton_gamma</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">*</span> <span class="n">get_proton_beta</span><span class="p">(</span>
        <span class="n">energy</span>
    <span class="p">)</span>  <span class="c1"># norm emittance to emittance</span>
    <span class="n">col_emittance</span> <span class="o">=</span> <span class="n">column_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>

    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_norm_nominal_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nominal</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_nominal_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nominal</span> <span class="o">/</span> <span class="n">normalization</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">col_emittance</span><span class="p">]</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_nemittance</span><span class="p">]</span> <span class="o">/</span> <span class="n">normalization</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_emittance</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_nemittance</span><span class="p">)]</span> <span class="o">/</span> <span class="n">normalization</span>
    <span class="k">return</span> <span class="n">kick_df</span>


<span class="c1"># Forced DA Fitting ------------------------------------------------------------</span>


<div class="viewcode-block" id="fun_exp_decay"><a class="viewcode-back" href="../../entrypoints/analysis.html#pylhc.forced_da_analysis.fun_exp_decay">[docs]</a><span class="k">def</span> <span class="nf">fun_exp_decay</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># fit and plot</span>
    <span class="sd">&quot;&quot;&quot;sp = DA_J, x[0] = action (2J res), x[1] = emittance&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="fun_exp_sigma"><a class="viewcode-back" href="../../entrypoints/analysis.html#pylhc.forced_da_analysis.fun_exp_sigma">[docs]</a><span class="k">def</span> <span class="nf">fun_exp_sigma</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># only used for plotting</span>
    <span class="sd">&quot;&quot;&quot;p = DA_sigma, x = action (J_sigma)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="fun_linear"><a class="viewcode-back" href="../../entrypoints/analysis.html#pylhc.forced_da_analysis.fun_linear">[docs]</a><span class="k">def</span> <span class="nf">fun_linear</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># fit and plot</span>
    <span class="sd">&quot;&quot;&quot;p = DA_J, x = action (2J res)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">p</span></div>


<div class="viewcode-block" id="swap_fun_parameters"><a class="viewcode-back" href="../../entrypoints/analysis.html#pylhc.forced_da_analysis.swap_fun_parameters">[docs]</a><span class="k">def</span> <span class="nf">swap_fun_parameters</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parameter swapped for Curvefit.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">fun</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_do_fit</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fitting forced da to exponential. &quot;</span><span class="p">)</span>
    <span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">,</span> <span class="n">rel_losses</span> <span class="o">=</span> <span class="n">_get_fit_data</span><span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
    <span class="n">init_guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">INITIAL_DA_FIT</span> <span class="o">*</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_nominal_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]]</span>

    <span class="n">get_fit_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">_linear_fit_parameters</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span> <span class="n">_exponential_fit_parameters</span><span class="p">}[</span>
        <span class="n">fit_type</span>
    <span class="p">]</span>

    <span class="n">fit_fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">get_fit_param</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">,</span> <span class="n">rel_losses</span><span class="p">)</span>

    <span class="c1"># do prelim fit</span>
    <span class="n">init_fit</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_fit_curve</span><span class="p">(</span><span class="n">swap_fun_parameters</span><span class="p">(</span><span class="n">fit_fun</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">init_guess</span><span class="p">)</span>

    <span class="c1"># do odr</span>
    <span class="n">odr</span> <span class="o">=</span> <span class="n">_fit_odr</span><span class="p">(</span><span class="n">fit_fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">init_fit</span><span class="p">)</span>

    <span class="c1"># add DA to kick</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">odr</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">odr</span><span class="o">.</span><span class="n">sd_beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da</span><span class="p">(</span><span class="n">plane</span><span class="p">)],</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da_error</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span> <span class="o">=</span> <span class="n">da</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forced DA (wrt. J) in </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2"> [m]: </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kick_df</span>


<span class="k">def</span> <span class="nf">_get_fit_data</span><span class="p">(</span><span class="n">kick_df</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts necessary data from ``kick-df``. Returns tri-tuple of tuples (data, std).&quot;&quot;&quot;</span>
    <span class="n">col_action</span> <span class="o">=</span> <span class="n">column_action</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">col_emittance</span> <span class="o">=</span> <span class="n">column_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">col_losses</span> <span class="o">=</span> <span class="n">rel_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">)</span>

    <span class="c1"># get data</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_action</span><span class="p">],</span> <span class="n">_no_nonzero_errors</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">)])</span>
    <span class="n">emittance</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_emittance</span><span class="p">],</span> <span class="n">_no_nonzero_errors</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_emittance</span><span class="p">)])</span>
    <span class="n">rel_losses</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_losses</span><span class="p">],</span> <span class="n">_no_nonzero_errors</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_losses</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">,</span> <span class="n">rel_losses</span>


<span class="k">def</span> <span class="nf">_exponential_fit_parameters</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">,</span> <span class="n">rel_losses</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns exponential fit function and parameters. All inputs are tuples of (data, std).&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">emittance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">rel_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sx</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">emittance</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">rel_losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fun_exp_decay</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span>


<span class="k">def</span> <span class="nf">_linear_fit_parameters</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">,</span> <span class="n">rel_losses</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns linear fit function and parameters. All inputs are tuples of (data, std).&quot;&quot;&quot;</span>
    <span class="n">log_losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rel_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">emittance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">log_losses</span>

    <span class="n">sx</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">log_losses</span> <span class="o">*</span> <span class="n">emittance</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">emittance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rel_losses</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">rel_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fun_linear</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span>


<span class="k">def</span> <span class="nf">_fit_curve</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initial curve fit, without errors.&quot;&quot;&quot;</span>
    <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">MAX_CURVEFIT_FEV</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial DA fit: </span><span class="si">{</span><span class="n">fit</span><span class="si">}</span><span class="s2"> with cov </span><span class="si">{</span><span class="n">cov</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_fit_odr</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ODR Fit (includes errors).&quot;&quot;&quot;</span>
    <span class="c1"># fill zero errors with the minimum error - otherwise fit will not work</span>
    <span class="n">fit_model_sigma</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">odr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="n">data_model_sigma</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">odr</span><span class="o">.</span><span class="n">RealData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="n">sy</span><span class="p">,)</span>
    <span class="n">da_odr</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">odr</span><span class="o">.</span><span class="n">ODR</span><span class="p">(</span><span class="n">data_model_sigma</span><span class="p">,</span> <span class="n">fit_model_sigma</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
    <span class="c1"># da_odr.set_job(fit_type=2)</span>
    <span class="n">odr_output</span> <span class="o">=</span> <span class="n">da_odr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">logging_tools</span><span class="o">.</span><span class="n">odr_pprint</span><span class="p">(</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">odr_output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">odr_output</span>


<span class="k">def</span> <span class="nf">_no_nonzero_errors</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes all zero-erros and replaces them with minimum errors in set.&quot;&quot;&quot;</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All errors are exact zero. Can&#39;t do ODR fit.&quot;</span><span class="p">)</span>
    <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">series</span>


<span class="k">def</span> <span class="nf">_convert_to_sigmas</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts the DA and the Action into Sigma-Units.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating action and da in sigmas.&quot;</span><span class="p">)</span>
    <span class="n">nominal_emittance</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_nominal_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span>
    <span class="n">emittance</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">column_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span>
    <span class="n">emittance_mean</span><span class="p">,</span> <span class="n">emittance_std</span> <span class="o">=</span> <span class="n">emittance</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">emittance</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">emittance_sign</span><span class="p">,</span> <span class="n">emittance_sign_std</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="p">(</span>
        <span class="n">emittance_mean</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">,</span> <span class="n">emittance_std</span> <span class="o">*</span> <span class="mf">1e12</span>
    <span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Measured Emittance </span><span class="si">{</span><span class="n">emittance_sign</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">emittance_sign_std</span><span class="si">}</span><span class="s2"> pm&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; (Nominal </span><span class="si">{</span><span class="n">nominal_emittance</span><span class="o">*</span><span class="mf">1e12</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2"> pm)&quot;</span>
    <span class="p">)</span>

    <span class="c1"># DA (in units of J) to DA_sigma</span>
    <span class="n">da</span><span class="p">,</span> <span class="n">da_err</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da</span><span class="p">(</span><span class="n">plane</span><span class="p">)],</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da_error</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span>
    <span class="n">da_sigma</span><span class="p">,</span> <span class="n">da_sigma_err</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">da</span> <span class="o">/</span> <span class="n">emittance_mean</span><span class="p">),</span>
        <span class="n">da_err</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">da</span> <span class="o">*</span> <span class="n">emittance_mean</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">da_sigma</span>
    <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da_error</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">da_sigma_err</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forced DA </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2"> in N-sigma: </span><span class="si">{</span><span class="n">da_sigma</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">da_sigma_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Action (in units of 2J) to J_sigma</span>
    <span class="n">col_action</span> <span class="o">=</span> <span class="n">column_action</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="c1"># kick_df[sigma_col(col_action)] = np.sqrt(kick_df[col_action] / nominal_emittance)</span>
    <span class="c1"># kick_df[err_col(sigma_col(col_action))] = (</span>
    <span class="c1">#         0.5 * kick_df[err_col(col_action)] / np.sqrt(kick_df[col_action] * nominal_emittance)</span>
    <span class="c1"># )</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">sigma_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">col_action</span><span class="p">]</span> <span class="o">/</span> <span class="n">emittance</span><span class="p">)</span>
    <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">sigma_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">)]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kick_df</span><span class="p">[</span><span class="n">col_action</span><span class="p">]</span> <span class="o">*</span> <span class="n">emittance</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">kick_df</span>


<span class="c1"># Plotting ---------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_plot_intensity</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">kick_df</span><span class="p">,</span> <span class="n">intensity_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots beam intensity. For losses, the absolute values are used and then normalized</span>
<span class="sd">    to the Intensity before the kicks, to get the percentage relative to that (global) value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting beam intensity&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">16.80</span><span class="p">,</span> <span class="mf">7.68</span><span class="p">))</span>

    <span class="n">x_span</span> <span class="o">=</span> <span class="p">(</span><span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># defines x-limits</span>

    <span class="c1"># convert to % relative to before first kick</span>
    <span class="n">idx_before</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
        <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">x_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span>
    <span class="p">)</span>
    <span class="n">idx_intensity</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">INTENSITY</span><span class="p">)</span>  <span class="c1"># for iloc</span>
    <span class="n">intensity_start</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_before</span><span class="p">,</span> <span class="n">idx_intensity</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">intensity_start</span> <span class="o">/</span> <span class="mf">100.0</span>

    <span class="c1"># plot intensity</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">_date2num</span><span class="p">(</span><span class="n">intensity_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="n">intensity_df</span><span class="p">[</span><span class="n">INTENSITY</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;lines.markersize&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># plot losses per kick</span>
    <span class="n">normalized_intensity</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">INTENSITY_BEFORE</span><span class="p">,</span> <span class="n">INTENSITY_AFTER</span><span class="p">]]</span> <span class="o">/</span> <span class="n">norm</span>
    <span class="n">normalized_intensity_error</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_BEFORE</span><span class="p">),</span> <span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_AFTER</span><span class="p">)]]</span> <span class="o">/</span> <span class="n">norm</span>
    <span class="p">)</span>
    <span class="n">normalized_losses</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">INTENSITY_LOSSES</span><span class="p">,</span> <span class="n">err_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">)]]</span> <span class="o">/</span> <span class="n">norm</span>
    <span class="n">normalized_losses_kick</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">kick_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">rel_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">),</span> <span class="n">err_col</span><span class="p">(</span><span class="n">rel_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">))]]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="p">[</span><span class="n">_date2num</span><span class="p">(</span><span class="n">kick</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">normalized_intensity</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kick</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">normalized_intensity_error</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kick</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;__nolegend__&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Losses&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">_date2num</span><span class="p">(</span><span class="n">kick</span><span class="p">),</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normalized_intensity</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kick</span><span class="p">,</span> <span class="p">:]),</span>
            <span class="s2">&quot;  -</span><span class="si">{:.1f}</span><span class="s2">$\pm$</span><span class="si">{:.1f}</span><span class="s2"> %</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">normalized_losses</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kick</span><span class="p">,</span> <span class="p">:])</span>
            <span class="o">+</span> <span class="s2">&quot; (-</span><span class="si">{:.1f}</span><span class="s2">$\pm$</span><span class="si">{:.1f}</span><span class="s2"> %)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">normalized_losses_kick</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kick</span><span class="p">,</span> <span class="p">:]),</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">_plot_kicks_and_scale_x</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">x_span</span><span class="p">)</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalized_intensity</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">normalized_intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">ypad</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ypad</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ypad</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Beam Intensity [%]&quot;</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">make_top_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intensity Beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">, Plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">set_annotation</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Intensity at 100%: </span><span class="si">{</span><span class="n">intensity_start</span><span class="o">*</span><span class="mf">1e-10</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;$\;\cdot\;10^{{10}}$ charges&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">position</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_save_fig</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">_plot_emittances</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">emittance_df</span><span class="p">,</span> <span class="n">emittance_bws_df</span><span class="p">,</span> <span class="n">kick_times</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting normalized emittances&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">10.24</span><span class="p">,</span> <span class="mf">7.68</span><span class="p">))</span>

    <span class="n">col_norm_emittance</span> <span class="o">=</span> <span class="n">column_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>

    <span class="n">bsrt_color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bws_color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">_date2num</span><span class="p">(</span><span class="n">emittance_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="n">emittance_df</span><span class="p">[</span><span class="n">col_norm_emittance</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>  <span class="c1"># Actual BSRT measurement</span>
        <span class="n">yerr</span><span class="o">=</span><span class="n">emittance_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_norm_emittance</span><span class="p">)]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">bsrt_color</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;From BSRT&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">_date2num</span><span class="p">(</span><span class="n">emittance_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="n">emittance_df</span><span class="p">[</span><span class="n">mean_col</span><span class="p">(</span><span class="n">col_norm_emittance</span><span class="p">)]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
        <span class="n">yerr</span><span class="o">=</span><span class="n">emittance_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">mean_col</span><span class="p">(</span><span class="n">col_norm_emittance</span><span class="p">))]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">change_color_brightness</span><span class="p">(</span><span class="n">bsrt_color</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Moving Average (window = </span><span class="si">{</span><span class="n">ROLLING_AVERAGE_WINDOW</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">emittance_bws_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">emittance_bws_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">BWS_DIRECTIONS</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;__nolegend__&quot;</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">BWS_DIRECTIONS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;From BWS&quot;</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bws_color</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">BWS_DIRECTIONS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">colors</span><span class="o">.</span><span class="n">change_color_brightness</span><span class="p">(</span><span class="n">bws_color</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">col_bws_nemittance</span> <span class="o">=</span> <span class="n">column_bws_norm_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">_date2num</span><span class="p">(</span><span class="n">emittance_bws_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                <span class="n">emittance_bws_df</span><span class="p">[</span><span class="n">col_bws_nemittance</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">emittance_bws_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_bws_nemittance</span><span class="p">)]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;lines.markersize&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">_plot_kicks_and_scale_x</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">kick_times</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{n}</span><span class="s2">$ $[\mu m]$&quot;</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">make_top_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emittance Beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">, Plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
    <span class="n">_save_fig</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;emittance&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">_plot_da_fit</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">k_df</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the Forced Dynamic Aperture fit.</span>
<span class="sd">    (I do not like the complexity of this function. jdilly).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting Dynamic Aperture Fit for </span><span class="si">{</span><span class="n">fit_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">col_action</span> <span class="o">=</span> <span class="n">column_action</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">col_action_sigma</span> <span class="o">=</span> <span class="n">sigma_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">)</span>
    <span class="n">col_emittance</span> <span class="o">=</span> <span class="n">column_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">col_intensity</span> <span class="o">=</span> <span class="n">rel_col</span><span class="p">(</span><span class="n">INTENSITY_LOSSES</span><span class="p">)</span>

    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">k_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kick_df</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col_action</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">10.24</span><span class="p">,</span> <span class="mf">7.68</span><span class="p">))</span>

    <span class="c1"># Plot Measurement Data</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_intensity</span><span class="p">]</span>
    <span class="n">intensity_err</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_intensity</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">intensity_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">intensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">intensity_err</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensity</span> <span class="o">*=</span> <span class="mi">100</span>
        <span class="n">intensity_err</span> <span class="o">*=</span> <span class="mi">100</span>

    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_action_sigma</span><span class="p">]</span>
        <span class="n">action_err</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_action_sigma</span><span class="p">)]</span>
        <span class="n">action_x</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">action_xerr</span> <span class="o">=</span> <span class="n">action_err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_action</span><span class="p">]</span>
        <span class="n">action_err</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">err_col</span><span class="p">(</span><span class="n">col_action</span><span class="p">)]</span>
        <span class="n">action_x</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="n">action_xerr</span> <span class="o">=</span> <span class="n">action_err</span> <span class="o">*</span> <span class="mf">1e6</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">action_x</span><span class="p">,</span>
        <span class="n">intensity</span><span class="p">,</span>
        <span class="n">xerr</span><span class="o">=</span><span class="n">action_xerr</span><span class="p">,</span>
        <span class="n">yerr</span><span class="o">=</span><span class="n">intensity_err</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Kicks&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Plot Fit</span>
    <span class="n">emittance</span> <span class="o">=</span> <span class="n">kick_df</span><span class="p">[</span><span class="n">col_emittance</span><span class="p">]</span>
    <span class="n">da</span><span class="p">,</span> <span class="n">da_err</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da</span><span class="p">(</span><span class="n">plane</span><span class="p">)],</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da_error</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span>
    <span class="n">da_mu</span><span class="p">,</span> <span class="n">da_err_mu</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="p">(</span><span class="n">da</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">da_err</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
    <span class="n">da_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fit: DA$_J$= $</span><span class="si">{</span><span class="n">da_mu</span><span class="si">}</span><span class="s2"> \pm </span><span class="si">{</span><span class="n">da_err_mu</span><span class="si">}</span><span class="s2"> \mu m$&quot;</span>

    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">fit_fun</span> <span class="o">=</span> <span class="n">fun_linear</span>
        <span class="n">fit_data</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">emittance</span>  <span class="c1"># DA-J/emittance = -ln(I/Io)</span>
    <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
        <span class="n">fit_fun</span> <span class="o">=</span> <span class="n">fun_exp_decay</span>
        <span class="n">fit_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">emittance</span><span class="p">)</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># for percentages</span>
    <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
        <span class="n">da</span><span class="p">,</span> <span class="n">da_err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)],</span>
            <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_da_error</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)],</span>
        <span class="p">)</span>
        <span class="n">da_round</span><span class="p">,</span> <span class="n">da_err_round</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">da_err</span><span class="p">)</span>
        <span class="n">da_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fit: DA= $</span><span class="si">{</span><span class="n">da_round</span><span class="si">}</span><span class="s2"> \pm </span><span class="si">{</span><span class="n">da_err_round</span><span class="si">}</span><span class="s2"> N_</span><span class="se">{{</span><span class="s2">\sigma</span><span class="se">}}</span><span class="s2">$&quot;</span>
        <span class="n">fit_fun</span> <span class="o">=</span> <span class="n">fun_exp_sigma</span>
        <span class="n">fit_data</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># for percentages</span>

    <span class="n">fit_mean</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">fit_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">fit_min</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span> <span class="o">-</span> <span class="n">da_err</span><span class="p">,</span> <span class="n">fit_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">fit_max</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span> <span class="o">+</span> <span class="n">da_err</span><span class="p">,</span> <span class="n">fit_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get_mpl_color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">action_x</span><span class="p">,</span> <span class="n">fit_min</span><span class="p">,</span> <span class="n">fit_max</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">action_x</span><span class="p">,</span> <span class="n">fit_mean</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">da_label</span><span class="p">)</span>

    <span class="c1"># extend fit to 100% losses</span>
    <span class="n">color_ext</span> <span class="o">=</span> <span class="s2">&quot;#7f7f7f&quot;</span>
    <span class="n">action_max</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">emittance_at_max</span> <span class="o">=</span> <span class="n">emittance</span><span class="p">[</span><span class="n">action</span> <span class="o">==</span> <span class="n">action_max</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fit_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">]:</span>
        <span class="n">da_x</span> <span class="o">=</span> <span class="n">da</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="n">da_string</span> <span class="o">=</span> <span class="s2">&quot;2DA$_J$&quot;</span>
    <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
        <span class="n">da_x</span> <span class="o">=</span> <span class="n">da</span>
        <span class="n">da_string</span> <span class="o">=</span> <span class="s2">&quot;DA$_\sigma$&quot;</span>

    <span class="k">if</span> <span class="n">action_max</span> <span class="o">&lt;</span> <span class="n">da</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fit_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">]:</span>
            <span class="n">action_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">action_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">da</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">action_x_ext</span> <span class="o">=</span> <span class="n">action_ext</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
                <span class="n">fit_data_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">action_ext</span><span class="p">,</span> <span class="n">emittance_at_max</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="n">fit_data_ext</span> <span class="o">=</span> <span class="n">action_ext</span>
                <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">emittance_at_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">action_max</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">action_x_ext</span> <span class="o">=</span> <span class="n">action_ext</span>
            <span class="n">fit_data_ext</span> <span class="o">=</span> <span class="n">action_ext</span>

        <span class="n">fit_ext</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">fit_data_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">action_x_ext</span><span class="p">,</span>
            <span class="n">fit_ext</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color_ext</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;__nolegend__&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># DA Marker</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">da_x</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_ext</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;__nolegend__&quot;</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>  <span class="c1"># x is data, y is axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">da_x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">da_string</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_ext</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Format figure</span>
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
        <span class="n">nominal_emittance</span> <span class="o">=</span> <span class="n">kick_df</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_nominal_emittance</span><span class="p">(</span><span class="n">plane</span><span class="p">)]</span>
        <span class="n">emittance_mean</span><span class="p">,</span> <span class="n">emittance_std</span> <span class="o">=</span> <span class="n">emittance</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">emittance</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">emittance_sign</span><span class="p">,</span> <span class="n">emittance_sign_std</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="p">(</span>
            <span class="n">emittance_mean</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">,</span> <span class="n">emittance_std</span> <span class="o">*</span> <span class="mf">1e12</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;$\epsilon_</span><span class="se">{{</span><span class="s2">mean</span><span class="se">}}</span><span class="s2">$ = </span><span class="si">{</span><span class="n">emittance_sign</span><span class="si">}</span><span class="s2"> $\pm$ </span><span class="si">{</span><span class="n">emittance_sign_std</span><span class="si">}</span><span class="s2"> pm &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;($\epsilon_</span><span class="se">{{</span><span class="s2">nominal</span><span class="se">}}</span><span class="s2">$ = </span><span class="si">{</span><span class="n">nominal_emittance</span><span class="o">*</span><span class="mf">1e12</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2"> pm)&quot;</span>
            <span class="p">),</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;$N_</span><span class="se">{{</span><span class="s2">\sigma</span><span class="se">}}</span><span class="s2"> = \sqrt</span><span class="se">{{</span><span class="s2">2J_</span><span class="se">{{</span><span class="si">{</span><span class="n">plane</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">}}</span><span class="s2">/\epsilon</span><span class="se">}}</span><span class="s2">$&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$2J_</span><span class="se">{{</span><span class="si">{</span><span class="n">plane</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">}}</span><span class="s2"> \; [\mu m]$&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;ln($I/I_0$)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Beam Losses [%]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">YPAD</span><span class="p">)])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">make_top_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;DA </span><span class="si">{</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span> <span class="k">else</span> <span class="s1">&#39;J&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fit_type</span><span class="si">}</span><span class="s2"> Fit </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">, Plane </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fig</span>
    <span class="p">)</span>
    <span class="n">_save_fig</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dafit_</span><span class="si">{</span><span class="n">fit_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">_get_fit_plot_data</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">da_err</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">):</span>
    <span class="n">fit_fun</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exponential&quot;</span><span class="p">:</span> <span class="n">fun_exp_decay</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">fun_linear</span><span class="p">}[</span><span class="n">fit_type</span><span class="p">]</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># for percentages</span>
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># DA-J/emittance = -ln(I/Io)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fit_mean</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">fit_min</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span> <span class="o">-</span> <span class="n">da_err</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">fit_max</span> <span class="o">=</span> <span class="n">fit_fun</span><span class="p">(</span><span class="n">da</span> <span class="o">+</span> <span class="n">da_err</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="k">return</span> <span class="n">fit_mean</span><span class="p">,</span> <span class="n">fit_min</span><span class="p">,</span> <span class="n">fit_max</span>


<span class="c1"># Helper ---</span>


<span class="k">def</span> <span class="nf">_plot_kicks_and_scale_x</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">kick_times</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">plot_vertical_lines_fast</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">kick_times</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Kicks&quot;</span>
    <span class="p">)</span>

    <span class="n">first_kick</span><span class="p">,</span> <span class="n">last_kick</span> <span class="o">=</span> <span class="n">kick_times</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">kick_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_delta</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">pad</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">time_delta</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

    <span class="c1"># ax.set_xlim([(first_kick - time_delta[0]).timestamp, last_kick + time_delta[1]])  # worked in the past</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">_date2num</span><span class="p">(</span><span class="n">first_kick</span> <span class="o">-</span> <span class="n">time_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">_date2num</span><span class="p">(</span><span class="n">last_kick</span> <span class="o">+</span> <span class="n">time_delta</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">set_annotation</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date: </span><span class="si">{</span><span class="n">first_kick</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_merge_df_planes</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="n">planes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In case planes == &#39;XY&#39; merge the ``df_dict`` into one dataframe..&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_dict</span><span class="p">[</span><span class="n">planes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="o">*</span><span class="n">df_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_maybe_add_sum_for_planes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">col_fun</span><span class="p">,</span> <span class="n">col_err_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In case planes == &#39;XY&#39; add the two plane columns and their errors.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col_err_fun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">[</span><span class="n">col_fun</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">col_err_fun</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">x_cols</span><span class="p">,</span> <span class="n">y_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">+</span> <span class="n">cols</span><span class="p">(</span><span class="n">planes</span><span class="p">))</span>
            <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">(</span><span class="n">planes</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">toolbox</span><span class="o">.</span><span class="n">df_sum_with_err</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">,</span> <span class="n">a_col</span><span class="o">=</span><span class="n">x_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_col</span><span class="o">=</span><span class="n">y_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a_err_col</span><span class="o">=</span><span class="n">x_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_err_col</span><span class="o">=</span><span class="n">y_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_fun</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col_fun</span><span class="p">(</span><span class="n">planes</span><span class="p">)]</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">df_sum</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">a_col</span><span class="o">=</span><span class="n">x_col</span><span class="p">,</span> <span class="n">b_col</span><span class="o">=</span><span class="n">y_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_date2num</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert CERNDatetime to mpl-number (days).</span>

<span class="sd">    Converts input times to plain-datetime first as date2num causes infinite loop with</span>
<span class="sd">    CernDateTimes in **Python 3.8**.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdt</span><span class="o">.</span><span class="n">datetime</span> <span class="k">for</span> <span class="n">cdt</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># probably datetime already</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># not iterable</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">datetime</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># probably datetime already</span>
    <span class="k">return</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_save_fig</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">PLOT_FILETYPES</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">outfile_plot</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">ftype</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving Figure to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t create output files for </span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2"> plots.&quot;</span><span class="p">)</span>


<span class="c1"># Script Mode ------------------------------------------------------------------</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>