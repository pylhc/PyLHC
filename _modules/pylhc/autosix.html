

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pylhc.autosix &mdash; pylhc 0.1.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/omc_logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Entrypoints</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/analysis.html">Analysis Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#bsrt-analysis">BSRT Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/analysis.html#forced-da-analysis">Forced DA Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/bpm_calibration.html">BPM Calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/bpm_calibration.html#id1">BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/machine_info.html">Machine Information Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/machine_info.html#print-machine-settings-overview">Print Machine Settings Overview</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/submitter.html">HTCondor Job Submitter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/submitter.html#job-submitter">Job Submitter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../entrypoints/submitter.html#autosix">AutoSix</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/calibration.html">BPM Calibration Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#beta">Beta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/calibration.html#dispersion">Dispersion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/constants.html">Constants Definitions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-general">Constants: General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-external-paths">Constants: External Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-autosix">Constants: Autosix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-forced-da-analysis">Constants: Forced DA Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-machine-settings-info">Constants: Machine Settings Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/constants.html#constants-bpm-calibration">Constants: BPM Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/data_extract.html">Data Extraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#pylsa">PyLSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/data_extract.html#timber">Timber</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/htc.html">HTCondor Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/htc.html#htcondor-utilities">HTCondor Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/htc.html#mask-resolver">Mask Resolver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/sixdesk_tools.html">Sixdesk Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sixdesk_tools.html#create-sixdesk-workspace">Create SixDesk Workspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sixdesk_tools.html#sixdesk-submission-utils">SixDesk Submission Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sixdesk_tools.html#post-process-da">Post Process DA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/sixdesk_tools.html#sixdesk-utilities">SixDesk Utilities</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pylhc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pylhc.autosix</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pylhc.autosix</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AutoSix</span>
<span class="sd">-------</span>

<span class="sd">A wrapper for SixDesk to perform the setup and steps needed automatically.</span>

<span class="sd">The idea is, to call this script with the same parameters and it runs through</span>
<span class="sd">all the steps automatically.</span>

<span class="sd">The functionality is similar to the :mod:`pylhc.job_submitter` in that</span>
<span class="sd">the inner product of a ``replace_dict`` is used to automatically create a set of</span>
<span class="sd">job-directories to gather the data.</span>
<span class="sd">To avoid conflicts each of these job-directories is a SixDesk workspace,</span>
<span class="sd">meaning there will be only one &quot;study&quot; per directory, .</span>

<span class="sd">The ``replace_dict`` contains variables for your mask as well as variables</span>
<span class="sd">for the SixDesk environment. See the description of ``replace_dict`` below.</span>
<span class="sd">In any other way, these *special* variables behave like normal variables and</span>
<span class="sd">can also be inserted in your mask. They are also looped over in the same manner</span>
<span class="sd">as any other variable (if given as a list).</span>

<span class="sd">.. important::</span>
<span class="sd">    As the loop over Seeds is handled by SixDesk you need to set</span>
<span class="sd">    `FIRSTSEED` and `LASTSEED` to ``None`` or ``0`` to deactivate this loop.</span>
<span class="sd">    Otherwise a ``%SEEDRAN`` placeholder is required in your mask,</span>
<span class="sd">    which needs to be present **after** filling in the variables (see example below).</span>


<span class="sd">.. note::</span>
<span class="sd">    Unlike in the :mod:`pylhc.job_submitter`, the output directory of the</span>
<span class="sd">    HTCondor job (the &#39;mask-job&#39;) is not automatically transferred to the</span>
<span class="sd">    workspace. To have access to this data, you will need to specify different</span>
<span class="sd">    output-directories in your mask manually, e.g. using strings containing</span>
<span class="sd">    the variable placeholders.</span>


<span class="sd">.. code-block:: python</span>

<span class="sd">    from pathlib import Path</span>
<span class="sd">    from omc3.utils import logging_tools</span>
<span class="sd">    from pylhc import autosix</span>

<span class="sd">    LOG = logging_tools.get_logger(__name__)</span>

<span class="sd">    if __name__ == &#39;__main__&#39;:</span>
<span class="sd">        autosix.main(</span>
<span class="sd">            working_directory=Path(&#39;/afs/cern.ch/work/u/user/sixdeskbase&#39;),</span>
<span class="sd">            mask=Path(&#39;my_madx.mask&#39;), # can contain any of the parameters used in replace_dict</span>
<span class="sd">            python=Path(&#39;/afs/cern.ch/work/u/user/my_venv/bin/python&#39;),</span>
<span class="sd">            ignore_twissfail_check=False,  # if script prints &#39;check if twiss failed&#39; or similar</span>
<span class="sd">            replace_dict=dict(</span>
<span class="sd">                # Part of the sixdesk-environment:</span>
<span class="sd">                TURNS=100000,</span>
<span class="sd">                AMPMIN=4, AMPMAX=30, AMPSTEP=2,</span>
<span class="sd">                ANGLES=11,</span>
<span class="sd">                # Examples for mask:</span>
<span class="sd">                BEAM=[1, 4],</span>
<span class="sd">                TUNE=[62.29, 62.30, 62.31, 62.31]</span>
<span class="sd">                OUTPUT=&#39;/afs/cern.ch/work/u/user/study_output/&#39;,</span>
<span class="sd">                SEED=&#39;%SEEDRAN&#39;,  # puts &#39;%SEEDRAN&#39; in the mask and lets sixdesk handle this loop</span>
<span class="sd">            ),</span>
<span class="sd">            jobid_mask=&quot;B%(BEAM)d-QX%(TUNE)s&quot;,</span>
<span class="sd">            # unlock=True,</span>
<span class="sd">            # resubmit=True,</span>
<span class="sd">            # ssh=&#39;lxplus.cern.ch&#39;,</span>
<span class="sd">        )</span>


<span class="sd">Upon running the script the job-matrix is created</span>
<span class="sd">(see *Jobs.tfs* in working directory) and the following stages are run per job:</span>

<span class="sd">- ``create_jobs``: create workspace; fill sysenv, sixdeskenv, mask.</span>
<span class="sd">- ``initialize_workspace``: initialize workspace from the env-files.</span>
<span class="sd">- ``submit_mask``: submit mask-job to HTCondor. (*interrupt*)</span>
<span class="sd">- ``check_input``: check if sixdesk input is complete.</span>
<span class="sd">- ``submit_sixtrack``: submit sixdesk-jobs to HTCondor. (*interrupt*)</span>
<span class="sd">- ``check_sixtrack_output``: check if all sixdesk jobs are completed.</span>
<span class="sd">- ``sixdb_load``: create database and load jobs output.</span>
<span class="sd">- ``sixdb_cmd``: calculated DA from database data.</span>
<span class="sd">- ``post_process``: extract data from database, write into *.tfs* and plot.</span>
<span class="sd">- ``final``: announce everything has finished</span>


<span class="sd">To keep track of the stages, they are written into the *stages\_completed.txt*</span>
<span class="sd">in the *autosix\_output* directory in the workspaces.</span>
<span class="sd">Stages that are written in this file are assumed to be done and will be skipped.</span>
<span class="sd">To rerun a stage, delete the stage and all following stages in that file and</span>
<span class="sd">start your script anew.</span>

<span class="sd">The stages are run independently of each job, meaning different jobs can be</span>
<span class="sd">at different stages. E.g if one job has all data for the ``six_db`` analysis</span>
<span class="sd">already, but the others are still running on sixdesk the</span>
<span class="sd">``check_sixtrack_output`` stage will fail for these jobs but the other one will</span>
<span class="sd">just continue.</span>

<span class="sd">Because the stages after ``submit_mask`` and ``submit_sixtrack`` need only be</span>
<span class="sd">run after the jobs on HTCondor are completed, these two stages interrupt the</span>
<span class="sd">execution of stages if they have successfully finished. Check your scheduler</span>
<span class="sd">via ``condor_q`` and run your script again after everything is done, to</span>
<span class="sd">have autosix continue its work.</span>

<span class="sd">.. note::</span>
<span class="sd">    While most studies should be fine with the input options given, there is the</span>
<span class="sd">    possibility to manually adapt the *sixdeskenv* and *sysenv* file before</span>
<span class="sd">    workspace initialization but adding the switch ``stop_workspace_init``.</span>
<span class="sd">    This will not reset automatically and one will have to remove the switch</span>
<span class="sd">    again to continue.</span>
<span class="sd">    As this is a bit of a workaround, it might be easier to define a new</span>
<span class="sd">    variable in the **pylhc.sixdesk_tools.mask_sixdeskenv** file and put its</span>
<span class="sd">    current default into **pylhc.constants.autosix.SIXENV_DEFAULT**.</span>
<span class="sd">    One can then use the ``replace_dict`` to change its value.</span>
<span class="sd">    This is left open as a task for the inspired user to implement, as only he</span>
<span class="sd">    knows which variable he or she needs to change.</span>


<span class="sd">AutoSix is not only able to run MAD-X masks, but also **cpymad** masks.</span>
<span class="sd">Requirement for the latter is to provide the ``executable`` path to a</span>
<span class="sd">python binary with **cpymad**, and all other packages used, installed.</span>

<span class="sd">To create the files needed for Sixtrack input, MAD-X masks need to contain</span>

<span class="sd">.. code-block:: bash</span>

<span class="sd">    if (NRJ&lt;5000.0000) {VRF400:=8.;} else {VRF400:=16.;};</span>
<span class="sd">    LAGRF400.B1=0.5;</span>
<span class="sd">    LAGRF400.B2=0.;</span>
<span class="sd">    twiss;</span>
<span class="sd">    sixtrack, cavall, radius=0.017;</span>


<span class="sd">while **cpymad** masks can do the same task with</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    madx.globals[&quot;VRF400&quot;] = 8 if madx.globals[&#39;NRJ&#39;] &lt; 5000 else 16</span>
<span class="sd">    madx.globals[&quot;LAGRF400.B1&quot;] = 0.5</span>
<span class="sd">    madx.globals[&quot;LAGRF400.B2&quot;] = 0.</span>
<span class="sd">    madx.twiss()  # used by sixtrack</span>
<span class="sd">    madx.sixtrack(cavall=True, radius=0.017)</span>


<span class="sd">In theory, any kind of mask is possible, given the correct ``executable``</span>
<span class="sd">is provided and the Sixtrack outputfiles created.</span>

<span class="sd">.. note::</span>
<span class="sd">    For the creation of polar plots, the function</span>
<span class="sd">    :func:`pylhc.sixdesk_tools.post_process_da.plot_polar` is available,</span>
<span class="sd">    which is used for the basic polar plotting in the ``post_process`` stage,</span>
<span class="sd">    but provides more customization features if called manually.</span>


<span class="sd">Arguments:</span>

<span class="sd">*--Required--*</span>

<span class="sd">- **mask** *(PathOrStr)*:</span>

<span class="sd">    Program mask to use</span>


<span class="sd">- **replace_dict** *(DictAsString)*:</span>

<span class="sd">    Dict with keys of the strings to be replaced in the mask (required) as</span>
<span class="sd">    well as the mask_sixdeskenv and mask_sysenv files in the sixdesk_tools</span>
<span class="sd">    module. Required fields are TURNS, AMPMIN, AMPMAX, AMPSTEP,</span>
<span class="sd">    ANGLES. Optional fields are RESUBMISSION, PLATFORM, LOGLEVEL,</span>
<span class="sd">    FIRSTSEED, LASTSEED, ENERGY, NPAIRS, EMITTANCE, DIMENSIONS, WRITEBINS.</span>
<span class="sd">    These keys can also be used in the mask if needed. The values of this</span>
<span class="sd">    dict are lists of values to replace these or single entries.</span>


<span class="sd">- **working_directory** *(PathOrStr)*:</span>

<span class="sd">    Directory where data should be put</span>


<span class="sd">*--Optional--*</span>

<span class="sd">- **da_turnstep** *(int)*:</span>

<span class="sd">    Step between turns used in DA-vs-Turns plot.</span>

<span class="sd">    default: ``100``</span>


<span class="sd">- **executable** *(PathOrStr)*:</span>

<span class="sd">    Path to executable.</span>

<span class="sd">    default: ``/afs/cern.ch/user/m/mad/bin/madx``</span>


<span class="sd">- **ignore_twissfail_check**:</span>

<span class="sd">    Ignore the check for &#39;Twiss fail&#39; in the submission file. This is a</span>
<span class="sd">    hack needed in case this check greps the wrong lines, e.g. in madx-</span>
<span class="sd">    comments. USE WITH CARE!!</span>

<span class="sd">    action: ``store_true``</span>


<span class="sd">- **jobid_mask** *(str)*:</span>

<span class="sd">    Mask to name jobs from replace_dict</span>


<span class="sd">- **python3** *(PathOrStr)*:</span>

<span class="sd">    Path to python to use with sixdb (python3 with requirements</span>
<span class="sd">    installed).</span>

<span class="sd">    default: ``python3``</span>


<span class="sd">- **python2** *(PathOrStr)*:</span>

<span class="sd">    Path to python to use with run_six.sh (python2 with requirements installed).</span>
<span class="sd">    ONLY THE PATH TO THE DIRECTORY OF THE python BINARY IS NEEDED!</span>
<span class="sd">    And it can&#39;t be an Anaconda Distribution.</span>

<span class="sd">    default: None (uses the first `python` in path)</span>


<span class="sd">- **resubmit**:</span>

<span class="sd">    Resubmits if needed.</span>

<span class="sd">    action: ``store_true``</span>


<span class="sd">- **ssh** *(str)*:</span>

<span class="sd">    Run htcondor from this machine via ssh (needs access to the</span>
<span class="sd">    `working_directory`)</span>


<span class="sd">- **stop_workspace_init**:</span>

<span class="sd">    Stops the workspace creation before initialization, so one can make</span>
<span class="sd">    manual changes.</span>

<span class="sd">    action: ``store_true``</span>


<span class="sd">- **unlock**:</span>

<span class="sd">    Forces unlocking of folders.</span>

<span class="sd">    action: ``store_true``</span>



<span class="sd">:author: jdilly</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tfs</span>
<span class="kn">from</span> <span class="nn">generic_parser</span> <span class="kn">import</span> <span class="n">EntryPointParameters</span><span class="p">,</span> <span class="n">entrypoint</span>
<span class="kn">from</span> <span class="nn">generic_parser.entry_datatypes</span> <span class="kn">import</span> <span class="n">DictAsString</span>
<span class="kn">from</span> <span class="nn">omc3.utils</span> <span class="kn">import</span> <span class="n">logging_tools</span>
<span class="kn">from</span> <span class="nn">omc3.utils.iotools</span> <span class="kn">import</span> <span class="n">PathOrStr</span><span class="p">,</span> <span class="n">save_config</span>

<span class="kn">from</span> <span class="nn">pylhc.constants.autosix</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">STAGES</span><span class="p">,</span>
    <span class="n">HEADER_BASEDIR</span><span class="p">,</span>
    <span class="n">get_stagefile_path</span><span class="p">,</span>
    <span class="n">DEFAULTS</span><span class="p">,</span>
    <span class="n">SIXENV_REQUIRED</span><span class="p">,</span>
    <span class="n">SIXENV_DEFAULT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pylhc.htc.mask</span> <span class="kn">import</span> <span class="n">generate_jobdf_index</span>
<span class="kn">from</span> <span class="nn">pylhc.job_submitter</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">JOBSUMMARY_FILE</span><span class="p">,</span>
    <span class="n">COLUMN_JOBID</span><span class="p">,</span>
    <span class="n">check_replace_dict</span><span class="p">,</span>
    <span class="n">keys_to_path</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pylhc.sixdesk_tools.create_workspace</span> <span class="kn">import</span> <span class="n">create_job</span><span class="p">,</span> <span class="n">remove_twiss_fail_check</span><span class="p">,</span> <span class="n">init_workspace</span>
<span class="kn">from</span> <span class="nn">pylhc.sixdesk_tools.post_process_da</span> <span class="kn">import</span> <span class="n">post_process_da</span>
<span class="kn">from</span> <span class="nn">pylhc.sixdesk_tools.submit</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">submit_mask</span><span class="p">,</span>
    <span class="n">submit_sixtrack</span><span class="p">,</span>
    <span class="n">check_sixtrack_input</span><span class="p">,</span>
    <span class="n">check_sixtrack_output</span><span class="p">,</span>
    <span class="n">sixdb_cmd</span><span class="p">,</span>
    <span class="n">sixdb_load</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pylhc.sixdesk_tools.utils</span> <span class="kn">import</span> <span class="n">is_locked</span><span class="p">,</span> <span class="n">check_mask</span><span class="p">,</span> <span class="n">check_stage</span><span class="p">,</span> <span class="n">StageSkip</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging_tools</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_params</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">EntryPointParameters</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">PathOrStr</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Program mask to use&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;working_directory&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">PathOrStr</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory where data should be put&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;replace_dict&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Dict with keys of the strings to be replaced in the mask (required) &quot;</span>
            <span class="s2">&quot;as well as the mask_sixdeskenv and mask_sysenv files &quot;</span>
            <span class="s2">&quot;in the sixdesk_tools module. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Required fields are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SIXENV_REQUIRED</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Optional fields are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SIXENV_DEFAULT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;These keys can also be used in the mask if needed. &quot;</span>
            <span class="s2">&quot;The values of this dict are lists of values to replace &quot;</span>
            <span class="s2">&quot;these or single entries.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">DictAsString</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;executable&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;executable&quot;</span><span class="p">],</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">PathOrStr</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to executable.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;python2&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;python2&quot;</span><span class="p">],</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">PathOrStr</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Path to python to use with run_six.sh (python2 with requirements installed).&quot;</span>
              <span class="s2">&quot; ONLY THE PATH TO THE DIRECTORY OF THE python BINARY IS NEEDED!&quot;</span>
              <span class="s2">&quot; And it can&#39;t be an Anaconda Distribution.&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">],</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">PathOrStr</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to python to use with sixdb (python3 with requirements installed).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;jobid_mask&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mask to name jobs from replace_dict&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ssh&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run htcondor from this machine via ssh (needs access to the `working_directory`)&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unlock&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Forces unlocking of folders.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ignore_twissfail_check&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Ignore the check for &#39;Twiss fail&#39; in the submission file. &quot;</span>
            <span class="s2">&quot;This is a hack needed in case this check greps the wrong lines, &quot;</span>
            <span class="s2">&quot;e.g. in madx-comments. USE WITH CARE!!&quot;</span>
        <span class="p">),</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;stop_workspace_init&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Stops the workspace creation before initialization,&quot;</span>
            <span class="s2">&quot; so one can make manual changes.&quot;</span>
        <span class="p">),</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;resubmit&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Resubmits if needed.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;da_turnstep&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Step between turns used in DA-vs-Turns plot.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;da_turnstep&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../entrypoints/submitter.html#pylhc.autosix.main">[docs]</a><span class="nd">@entrypoint</span><span class="p">(</span><span class="n">get_params</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Loop to create jobs from replace dict product matrix. &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting autosix.&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mask_f</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">_check_opts</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
    <span class="n">save_config</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">)</span>

    <span class="n">jobdf</span> <span class="o">=</span> <span class="n">_generate_jobs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">jobid_mask</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="o">.</span><span class="n">replace_dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">job_args</span> <span class="ow">in</span> <span class="n">jobdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">setup_and_run</span><span class="p">(</span>
            <span class="n">jobname</span><span class="o">=</span><span class="n">job_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">basedir</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
            <span class="c1"># kwargs:</span>
            <span class="n">ssh</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">ssh</span><span class="p">,</span>
            <span class="n">python2</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">python2</span><span class="p">,</span>
            <span class="n">python3</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">python3</span><span class="p">,</span>
            <span class="n">unlock</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">unlock</span><span class="p">,</span>
            <span class="n">resubmit</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">resubmit</span><span class="p">,</span>
            <span class="n">da_turnstep</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">da_turnstep</span><span class="p">,</span>
            <span class="n">ignore_twissfail_check</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">ignore_twissfail_check</span><span class="p">,</span>
            <span class="c1"># kwargs passed only to create_jobs:</span>
            <span class="n">mask_text</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">binary_path</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
            <span class="n">stop_workspace_init</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">stop_workspace_init</span><span class="p">,</span>
            <span class="o">**</span><span class="n">job_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="setup_and_run"><a class="viewcode-back" href="../../entrypoints/submitter.html#pylhc.autosix.setup_and_run">[docs]</a><span class="k">def</span> <span class="nf">setup_and_run</span><span class="p">(</span><span class="n">jobname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">basedir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main submitting procedure for single job.</span>

<span class="sd">    Args:</span>
<span class="sd">        jobname (str): Name of the job/study</span>
<span class="sd">        basedir (Path): Working directory</span>

<span class="sd">    Keyword Args (optional):</span>
<span class="sd">        unlock (bool): unlock folder</span>
<span class="sd">        ssh (str): ssh-server to use</span>
<span class="sd">        python (str): python binary to use for sixDB</span>
<span class="sd">        resubmit(bool): Resubmit jobs if checks fail</span>
<span class="sd">        da_turnstep (int): Step in turns for DA</span>
<span class="sd">        ignore_twissfail_check (bool): Hack to ignore check for &#39;Twiss fail&#39; after run</span>

<span class="sd">    Keyword Args (needed for create jobs):</span>
<span class="sd">        mask_text (str): Content of the mask to use.</span>
<span class="sd">        binary_path (Path): path to binary to use in jobs</span>
<span class="sd">        All Key=Values needed to fill the mask!</span>
<span class="sd">        All Key=Values needed to fill the mask!</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vv---------------- Job </span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2"> -------------------vv&quot;</span><span class="p">)</span>
    <span class="n">unlock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;unlock&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">ssh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ssh&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">python2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;python2&quot;</span><span class="p">,</span> <span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;python2&quot;</span><span class="p">])</span>
    <span class="n">python3</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span> <span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">])</span>
    <span class="n">resubmit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resubmit&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">da_turnstep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;da_turnstep&quot;</span><span class="p">,</span> <span class="n">DEFAULTS</span><span class="p">[</span><span class="s2">&quot;da_turnstep&quot;</span><span class="p">])</span>
    <span class="n">ignore_twissfail_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ignore_twissfail_check&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">stop_workspace_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stop_workspace_init&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_locked</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">unlock</span><span class="o">=</span><span class="n">unlock</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2"> is locked. Try &#39;unlock&#39; flag if this causes errors.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">create_job</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create workspace</span>
<span class="sd">        &gt; cd $basedir</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/set_env.sh -N workspace-$jobname</span>

<span class="sd">        write sixdeskenv, sysenv, filled mask (manual)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">create_job</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">initialize_workspace</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize workspace</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/set_env.sh -s</span>

<span class="sd">        remove the twiss-fail check in sixtrack_input</span>
<span class="sd">        (manual)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stop_workspace_init</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Workspace creation for job </span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2"> interrupted.&quot;</span>
                    <span class="s2">&quot; Check directory to manually adapt `sixdeskenv`&quot;</span>
                    <span class="s2">&quot; and `sysenv`. Remove &#39;stop_workspace_init&#39; from input&quot;</span>
                    <span class="s2">&quot; parameters or set to &#39;False&#39; to continue run.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">StageSkip</span><span class="p">()</span>

            <span class="n">init_workspace</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ignore_twissfail_check</span><span class="p">:</span>  <span class="c1"># Hack</span>
                <span class="n">remove_twiss_fail_check</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">submit_mask</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        submit for input generation</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/mad6t.sh -s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">submit_mask</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># takes a while, so we interrupt here</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">check_input</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if input files have been generated properly</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/mad6t.sh -c</span>

<span class="sd">        If not, and resubmit is active</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/mad6t.sh -w</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">check_sixtrack_input</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">,</span> <span class="n">resubmit</span><span class="o">=</span><span class="n">resubmit</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">submit_sixtrack</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate simulation files (-g) and check if runnable (-c) and submit (-s) (-g -c -s == -a).</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/run_six.sh -a</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">submit_sixtrack</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="n">python2</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># takes even longer</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">check_sixtrack_output</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks sixtrack output via run_status. If this fails even though all</span>
<span class="sd">        jobs have finished on the scheduler, check the log-output (run_status</span>
<span class="sd">        messages are logged to debug).</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/run_status</span>

<span class="sd">        If not, and resubmit is active</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/bash/run_six.sh -i</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">check_sixtrack_output</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="n">python2</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">,</span> <span class="n">resubmit</span><span class="o">=</span><span class="n">resubmit</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">sixdb_load</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gather results into database via sixdb.</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; python3 /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/externals/SixDeskDB/sixdb . load_dir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">sixdb_load</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="n">python3</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">sixdb_cmd</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analysise results in database via sixdb.</span>
<span class="sd">        &gt; cd $basedir/workspace-$jobname/sixjobs</span>
<span class="sd">        &gt; python3 /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/externals/SixDeskDB/sixdb $jobname da</span>

<span class="sd">        when fixed:</span>
<span class="sd">        &gt; python3 /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/externals/SixDeskDB/sixdb $jobname da_vs_turns -turnstep 100 -outfile</span>
<span class="sd">        &gt; python3 /afs/cern.ch/project/sixtrack/SixDesk_utilities/pro/utilities/externals/SixDeskDB/sixdb $jobname plot_da_vs_turns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">sixdb_cmd</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;da&quot;</span><span class="p">],</span> <span class="n">python</span><span class="o">=</span><span class="n">python3</span><span class="p">,</span> <span class="n">ssh</span><span class="o">=</span><span class="n">ssh</span><span class="p">)</span>

            <span class="c1"># da_vs_turns is broken at the moment (jdilly, 19.10.2020)</span>
            <span class="c1"># sixdb_cmd(jobname, basedir, cmd=[&#39;da_vs_turns&#39;, &#39;-turnstep&#39;, str(da_turnstep), &#39;-outfile&#39;],</span>
            <span class="c1">#           python=python, ssh=ssh)</span>
            <span class="c1"># sixdb_cmd(jobname, basedir, cmd=[&#39;plot_da_vs_turns&#39;], python=python, ssh=ssh)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">post_process</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the analysed data in the database and writes them to three tfs files:</span>

<span class="sd">        - All DA values</span>
<span class="sd">        - Statistics over angles, listed per seed (+ Seed 0 as over seeds and angles)</span>
<span class="sd">        - Statistics over seeds, listed per angle</span>

<span class="sd">        The statistics over the seeds are then plotted in a polar plot.</span>
<span class="sd">        All files are outputted to the ``sixjobs/autosix_output`` folder in the job directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">post_process_da</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">check_stage</span><span class="p">(</span><span class="n">STAGES</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span> <span class="k">as</span> <span class="n">check_ok</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Just info about finishing this script and where to check the stagefile. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_ok</span><span class="p">:</span>
            <span class="n">stage_file</span> <span class="o">=</span> <span class="n">get_stagefile_path</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;All stages run. Check stagefile </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">stage_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;in case you want to rerun some stages.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">StageSkip</span><span class="p">()</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^^---------------- Job </span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2"> -------------------^^&quot;</span><span class="p">)</span></div>


<span class="c1"># Helper for main --------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_check_opts</span><span class="p">(</span><span class="n">mask_text</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">keys_to_path</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;working_directory&quot;</span><span class="p">,</span> <span class="s2">&quot;executable&quot;</span><span class="p">)</span>
    <span class="n">check_mask</span><span class="p">(</span><span class="n">mask_text</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">replace_dict</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">replace_dict</span> <span class="o">=</span> <span class="n">check_replace_dict</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">replace_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opt</span>


<span class="k">def</span> <span class="nf">_generate_jobs</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">jobid_mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Generates product matrix for job-values and stores it as TfsDataFrame. &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating Jobs&quot;</span><span class="p">)</span>
    <span class="n">values_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">job_df</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">(</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="n">HEADER_BASEDIR</span><span class="p">:</span> <span class="n">basedir</span><span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">generate_jobdf_index</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">jobid_mask</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">values_grid</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">values_grid</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">basedir</span> <span class="o">/</span> <span class="n">JOBSUMMARY_FILE</span><span class="p">,</span> <span class="n">job_df</span><span class="p">,</span> <span class="n">save_index</span><span class="o">=</span><span class="n">COLUMN_JOBID</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">job_df</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019-2020, pyLHC/OMC-TEAM.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>