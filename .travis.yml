env:
  global:
    - CC_TEST_REPORTER_ID=0e27bf1c9efa4cf36ab9fcd5398fa2963e197abdb7b9e4bdd93668112809d89a

stages:
  - test
  - name: documentation
    if: tag =~ ^v\d+\.\d+\.\d+.*
  - name: package
    if: tag =~ ^v\d+\.\d+\.\d+.*

# Default python version that will be inherited
# Additional ones can be defined later
language: python
python: 3.6

email:
  on_success: never
  on_failure: never

jobs:
  include:
    - &test-stage
      stage: test
      install: skip # override to not install requirements.txt (dependencies handled by setup.py)
      before_script:
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter before-build
        - python -m pip install -e git+git://github.com/pylhc/omc3.git#egg=omc3
        # - python -m pip install -e git+git://gitlab.cern.ch/scripting-tools/pyjapc.git#egg=pyjapc
      script:
        - python setup.py test --pytest_args='--mpl'
      after_script:
        - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT

    # Define additional python versions for tests
    - <<: *test-stage
      python: 3.7

#    - <<: *test-stage   # had to be removed as htcondor does not exists for 3.8 yet (check in future)
#      python: 3.8

    - stage: documentation
      install:
        - pip install '.[doc]'
      script:
        - travis-sphinx build --source=doc/ --nowarn
      after_success:
        - travis-sphinx deploy

    - stage: package
      install:
        - pip install twine
      before_script:
        - |
          cat << EOF | tee ~/.pypirc 1>/dev/null
          [distutils]
          index-servers=
              pypi
          [pypi]
            username: $PYPI_USERNAME
            password: $PYPI_PASSWORD
      script:
        - python setup.py sdist bdist_wheel
        - twine check dist/*
        - twine upload dist/*
